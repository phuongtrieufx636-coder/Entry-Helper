<!DOCTYPE html>

<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAU/USD - Advanced Technical Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

```
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 15px;
        min-height: 100vh;
    }
    
    .container { max-width: 1800px; margin: 0 auto; }
    
    .header {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .price-status {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
        margin: 10px auto;
        width: fit-content;
    }
    
    .price-status.real { background: #d4edda; color: #155724; }
    .price-status.loading { background: #fff3cd; color: #856404; }
    .price-status.cached { background: #d1ecf1; color: #0c5460; }
    .price-status.simulated { background: #f8d7da; color: #721c24; }
    
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .real .status-dot { background: #28a745; }
    .loading .status-dot { background: #ffc107; }
    .cached .status-dot { background: #17a2b8; }
    .simulated .status-dot { background: #dc3545; }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .price-display {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 15px 0;
        flex-wrap: wrap;
    }
    
    .price-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 15px 25px;
        border-radius: 12px;
        color: white;
        min-width: 160px;
        text-align: center;
    }
    
    .price-label { font-size: 0.85em; opacity: 0.9; margin-bottom: 5px; }
    .price-value { font-size: 1.6em; font-weight: bold; }
    
    .refresh-btn {
        padding: 10px 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        display: block;
        margin: 15px auto;
    }
    
    .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    @media (max-width: 1400px) {
        .main-grid { grid-template-columns: 1fr 1fr; }
    }
    
    @media (max-width: 900px) {
        .main-grid { grid-template-columns: 1fr; }
    }
    
    .card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .card h2 {
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 3px solid #667eea;
        font-size: 1.2em;
    }
    
    .indicator-grid {
        display: grid;
        gap: 10px;
    }
    
    .indicator-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    
    .indicator-name {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
    }
    
    .indicator-value {
        font-weight: bold;
        font-size: 1.1em;
        color: #2c3e50;
    }
    
    .signal-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        margin-left: 8px;
    }
    
    .badge-buy { background: #28a745; color: white; }
    .badge-sell { background: #dc3545; color: white; }
    .badge-neutral { background: #ffc107; color: #333; }
    .badge-strong { background: #007bff; color: white; }
    .badge-weak { background: #6c757d; color: white; }
    
    .tf-card {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
        background: #f8f9fa;
    }
    
    .tf-card.bullish {
        border-color: #28a745;
        background: linear-gradient(to right, #d4edda 0%, #f8f9fa 100%);
    }
    
    .tf-card.bearish {
        border-color: #dc3545;
        background: linear-gradient(to right, #f8d7da 0%, #f8f9fa 100%);
    }
    
    .tf-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .tf-name { font-weight: bold; font-size: 1.05em; }
    
    .confluence-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin: 15px 0;
        text-align: center;
    }
    
    .confluence-score {
        font-size: 2.5em;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .setup-card {
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 12px;
        color: white;
    }
    
    .setup-card.high { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); }
    .setup-card.medium { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .setup-card.low { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    
    .setup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .setup-title { font-size: 1.1em; font-weight: bold; }
    .setup-confidence {
        background: rgba(255,255,255,0.3);
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.85em;
    }
    
    .setup-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
        gap: 8px;
    }
    
    .setup-item {
        background: rgba(255,255,255,0.2);
        padding: 10px;
        border-radius: 8px;
        text-align: center;
    }
    
    .setup-label { font-size: 0.75em; opacity: 0.9; }
    .setup-value { font-size: 1.1em; font-weight: bold; margin-top: 3px; }
    
    .ai-section {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-top: 20px;
    }
    
    .ai-section h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #667eea;
    }
    
    .ai-input-group {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
    }
    
    .ai-select, .ai-input {
        padding: 12px;
        border: 2px solid #667eea;
        border-radius: 8px;
        font-size: 1em;
    }
    
    .ai-input {
        min-width: 300px;
    }
    
    .ai-button {
        padding: 12px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .ai-button:hover {
        transform: translateY(-2px);
    }
    
    .ai-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .ai-loading {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .ai-loading.show {
        display: block;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .ai-response {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
        margin-top: 20px;
        white-space: pre-wrap;
        line-height: 1.6;
        display: none;
    }
    
    .ai-response.show {
        display: block;
    }
    
    .json-preview {
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 0.85em;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 15px;
    }
    
    .json-preview::-webkit-scrollbar {
        width: 8px;
    }
    
    .json-preview::-webkit-scrollbar-track {
        background: #1a1a1a;
    }
    
    .json-preview::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 4px;
    }
    
    .toggle-json {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 10px;
    }
    
    .pattern-box {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
    }
    
    .pattern-name {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 8px;
    }
    
    .pattern-desc {
        font-size: 0.9em;
        opacity: 0.95;
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="text-align:center; color:#2c3e50; margin-bottom:15px;">
                üéØ XAU/USD - Advanced Technical Analysis
            </h1>

```
        <div id="priceStatus" class="price-status loading">
            <span class="status-dot"></span>
            <span id="statusText">ƒêang t·∫£i gi√°...</span>
        </div>
        
        <div class="price-display">
            <div class="price-box">
                <div class="price-label">Gi√° Hi·ªán T·∫°i</div>
                <div class="price-value" id="currentPrice">--</div>
            </div>
            <div class="price-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="price-label">Bid</div>
                <div class="price-value" id="bidPrice">--</div>
            </div>
            <div class="price-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="price-label">Ask</div>
                <div class="price-value" id="askPrice">--</div>
            </div>
            <div class="price-box" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="price-label">24h Change</div>
                <div class="price-value" id="priceChange">--</div>
            </div>
        </div>
        
        <div style="text-align:center; color:#666; font-size:0.85em; margin:10px 0;" id="updateTime">--</div>
        <button class="refresh-btn" onclick="updatePrice()">üîÑ C·∫≠p Nh·∫≠t D·ªØ Li·ªáu</button>
    </div>

    <div class="main-grid">
        <!-- Column 1: Oscillators & Momentum -->
        <div class="card">
            <h2>‚ö° Oscillators & Momentum</h2>
            <div class="indicator-grid" id="oscillators"></div>
        </div>

        <!-- Column 2: Moving Averages & Trend -->
        <div class="card">
            <h2>üìà Moving Averages & Trend</h2>
            <div class="indicator-grid" id="movingAverages"></div>
        </div>

        <!-- Column 3: Pivot Points & Fibonacci -->
        <div class="card">
            <h2>üéØ Pivot Points & Fibonacci</h2>
            <div class="indicator-grid" id="pivotFib"></div>
        </div>
    </div>

    <!-- Volume & Market Structure -->
    <div class="main-grid">
        <div class="card">
            <h2>üìä Volume & Volatility</h2>
            <div class="indicator-grid" id="volumeVolatility"></div>
        </div>

        <div class="card">
            <h2>üîç Chart Patterns</h2>
            <div id="chartPatterns"></div>
        </div>

        <div class="card">
            <h2>üí° Market Sentiment</h2>
            <div class="indicator-grid" id="marketSentiment"></div>
        </div>
    </div>

    <!-- Timeframe Analysis -->
    <div class="main-grid">
        <div class="card">
            <h2>üìä Multi-Timeframe Analysis</h2>
            <div id="timeframeAnalysis"></div>
            
            <div class="confluence-section">
                <h3 style="margin-bottom:5px;">Confluence Score</h3>
                <div class="confluence-score" id="confluenceScore">--</div>
                <div style="font-size:0.85em;">ƒê·ªô tin c·∫≠y t√≠n hi·ªáu t·ªïng h·ª£p</div>
            </div>
        </div>

        <div class="card" style="grid-column: span 2;">
            <h2>üí° Trading Setups</h2>
            <div id="entrySetups"></div>
        </div>
    </div>

    <!-- AI Analysis Section -->
    <div class="ai-section">
        <h2>ü§ñ AI Analysis - Ph√¢n T√≠ch Chuy√™n S√¢u</h2>
        <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">
            AI s·∫Ω nh·∫≠n to√†n b·ªô d·ªØ li·ªáu k·ªπ thu·∫≠t d∆∞·ªõi d·∫°ng JSON ƒë·ªÉ ph√¢n t√≠ch s√¢u h∆°n
        </p>
        
        <div class="ai-input-group">
            <select class="ai-select" id="aiProvider">
                <option value="claude">Claude API</option>
                <option value="openai">OpenAI API</option>
            </select>
            <input type="password" class="ai-input" id="apiKey" placeholder="Nh·∫≠p API Key c·ªßa b·∫°n (sk-ant-... ho·∫∑c sk-...)">
            <button class="ai-button" id="aiAnalyzeBtn" onclick="analyzeWithAI()">üîç Ph√¢n T√≠ch V·ªõi AI</button>
        </div>
        
        <button class="toggle-json" onclick="toggleJSON()">üëÅÔ∏è Xem JSON Data G·ª≠i Cho AI</button>
        <div class="json-preview" id="jsonPreview" style="display:none;"></div>
        
        <div class="ai-loading" id="aiLoading">
            <div class="spinner"></div>
            <p>ƒêang g·ª≠i d·ªØ li·ªáu v√† ch·ªù AI ph√¢n t√≠ch...</p>
        </div>
        
        <div class="ai-response" id="aiResponse"></div>
    </div>
</div>

<script>
    let currentPrice = null;
    let marketData = {};
    let technicalData = {};
    let priceSource = 'LOADING';
    let retryAttempt = 0;

    // Fetch price
    async function fetchPrice() {
        console.log(`üîÑ Fetching price (attempt ${retryAttempt + 1})...`);
        updatePriceStatus('loading', 'ƒêang t·∫£i gi√° real-time...');
        
        // Binance
        try {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 4000);
            
            const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=PAXGUSDT', {
                signal: controller.signal
            });
            const data = await res.json();
            
            if (data && data.price) {
                const price = parseFloat(data.price);
                console.log('‚úÖ Binance:', price);
                updatePriceStatus('real', 'Gi√° th·ª±c t·ª´ Binance');
                retryAttempt = 0;
                localStorage.setItem('xau_last_price', JSON.stringify({price, time: Date.now()}));
                return price;
            }
        } catch (e) {
            console.log('‚ùå Binance failed:', e.message);
        }

        // CoinGecko
        try {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 4000);
            
            const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=pax-gold&vs_currencies=usd', {
                signal: controller.signal
            });
            const data = await res.json();
            
            if (data && data['pax-gold']?.usd) {
                const price = data['pax-gold'].usd;
                console.log('‚úÖ CoinGecko:', price);
                updatePriceStatus('real', 'Gi√° th·ª±c t·ª´ CoinGecko');
                retryAttempt = 0;
                localStorage.setItem('xau_last_price', JSON.stringify({price, time: Date.now()}));
                return price;
            }
        } catch (e) {
            console.log('‚ùå CoinGecko failed:', e.message);
        }

        // Cached
        try {
            const cached = JSON.parse(localStorage.getItem('xau_last_price'));
            if (cached && (Date.now() - cached.time < 3600000)) {
                console.log('‚ö†Ô∏è Using cached:', cached.price);
                updatePriceStatus('cached', 'Gi√° t·ª´ cache (< 1h)');
                
                retryAttempt++;
                if (retryAttempt < 3) {
                    setTimeout(() => fetchPrice().then(p => p && updatePrice()), 10000);
                }
                
                return cached.price;
            }
        } catch (e) {}

        // Simulated
        console.log('‚ö†Ô∏è Using simulation');
        updatePriceStatus('simulated', 'Gi√° m√¥ ph·ªèng (API offline)');
        
        const basePrice = currentPrice || 2656;
        const variation = (Math.sin(Date.now() / 10000) * 10) + (Math.random() - 0.5) * 4;
        
        retryAttempt++;
        if (retryAttempt < 3) {
            setTimeout(() => fetchPrice().then(p => p && updatePrice()), 15000);
        }
        
        return basePrice + variation;
    }

    function updatePriceStatus(type, text) {
        const statusEl = document.getElementById('priceStatus');
        const textEl = document.getElementById('statusText');
        
        statusEl.className = `price-status ${type}`;
        textEl.textContent = text;
    }

    // Calculate all technical indicators
    function calculateTechnicalIndicators(price) {
        const atr = 8 + Math.random() * 4;
        
        // Oscillators
        const rsi = 35 + Math.floor(Math.random() * 30);
        const stochastic = 30 + Math.floor(Math.random() * 40);
        const cci = -100 + Math.floor(Math.random() * 200);
        const williams = -80 + Math.floor(Math.random() * 60);
        const momentum = (Math.random() - 0.5) * 20;
        const roc = (Math.random() - 0.5) * 3;
        
        // Moving Averages
        const ema20 = price - (Math.random() - 0.5) * 10;
        const ema50 = price - (Math.random() - 0.3) * 20;
        const ema200 = price - (Math.random() - 0.2) * 50;
        const sma20 = price - (Math.random() - 0.5) * 12;
        const sma50 = price - (Math.random() - 0.3) * 22;
        const sma200 = price - (Math.random() - 0.2) * 52;
        const vwap = price - (Math.random() - 0.5) * 5;
        
        // Bollinger Bands
        const bbUpper = price + atr * 2;
        const bbLower = price - atr * 2;
        const bbPosition = ((price - bbLower) / (bbUpper - bbLower) * 100).toFixed(0);
        
        // Ichimoku
        const tenkan = price - (Math.random() - 0.5) * 8;
        const kijun = price - (Math.random() - 0.5) * 15;
        const senkouA = (tenkan + kijun) / 2;
        const senkouB = price - (Math.random() - 0.3) * 25;
        
        // Pivot Points (Standard)
        const high = price + atr * 0.8;
        const low = price - atr * 0.8;
        const close = price;
        const pivot = (high + low + close) / 3;
        const r1 = 2 * pivot - low;
        const r2 = pivot + (high - low);
        const r3 = high + 2 * (pivot - low);
        const s1 = 2 * pivot - high;
        const s2 = pivot - (high - low);
        const s3 = low - 2 * (high - pivot);
        
        // Fibonacci Retracement (from recent high/low)
        const recentHigh = price + atr * 2;
        const recentLow = price - atr * 2;
        const range = recentHigh - recentLow;
        const fib236 = recentHigh - range * 0.236;
        const fib382 = recentHigh - range * 0.382;
        const fib50 = recentHigh - range * 0.5;
        const fib618 = recentHigh - range * 0.618;
        const fib786 = recentHigh - range * 0.786;
        
        // Volume & Volatility
        const volume = 1000000 + Math.floor(Math.random() * 500000);
        const avgVolume = 1200000;
        const volumeRatio = (volume / avgVolume * 100).toFixed(0);
        const atrPercent = (atr / price * 100).toFixed(2);
        
        // ADX (Trend Strength)
        const adx = 20 + Math.floor(Math.random() * 40);
        const plusDI = 20 + Math.floor(Math.random() * 30);
        const minusDI = 20 + Math.floor(Math.random() * 30);
        
        // Chart Patterns Detection
        const patterns = detectPatterns(price, ema20, ema50, rsi);
        
        // Market Sentiment
        const bullPower = (Math.random() - 0.5) * 10;
        const bearPower = (Math.random() - 0.5) * 10;
        const fearGreedIndex = 40 + Math.floor(Math.random() * 30);
        
        return {
            price,
            atr,
            oscillators: {
                rsi: { value: rsi, signal: rsi > 70 ? 'SELL' : rsi < 30 ? 'BUY' : 'NEUTRAL' },
                stochastic: { value: stochastic, signal: stochastic > 80 ? 'SELL' : stochastic < 20 ? 'BUY' : 'NEUTRAL' },
                cci: { value: cci, signal: cci > 100 ? 'SELL' : cci < -100 ? 'BUY' : 'NEUTRAL' },
                williams: { value: williams, signal: williams > -20 ? 'SELL' : williams < -80 ? 'BUY' : 'NEUTRAL' },
                momentum: { value: momentum.toFixed(2), signal: momentum > 5 ? 'BUY' : momentum < -5 ? 'SELL' : 'NEUTRAL' },
                roc: { value: roc.toFixed(2), signal: roc > 0 ? 'BUY' : 'SELL' }
            },
            movingAverages: {
                ema20: { value: ema20.toFixed(2), signal: price > ema20 ? 'BUY' : 'SELL' },
                ema50: { value: ema50.toFixed(2), signal: price > ema50 ? 'BUY' : 'SELL' },
                ema200: { value: ema200.toFixed(2), signal: price > ema200 ? 'BUY' : 'SELL' },
                sma20: { value: sma20.toFixed(2), signal: price > sma20 ? 'BUY' : 'SELL' },
                sma50: { value: sma50.toFixed(2), signal: price > sma50 ? 'BUY' : 'SELL' },
                sma200: { value: sma200.toFixed(2), signal: price > sma200 ? 'BUY' : 'SELL' },
                vwap: { value: vwap.toFixed(2), signal: price > vwap ? 'BUY' : 'SELL' }
            },
            bollingerBands: {
                upper: bbUpper.toFixed(2),
                lower: bbLower.toFixed(2),
                position: bbPosition,
                signal: bbPosition > 80 ? 'SELL' : bbPosition < 20 ? 'BUY' : 'NEUTRAL'
            },
            ichimoku: {
                tenkan: tenkan.toFixed(2),
                kijun: kijun.toFixed(2),
                senkouA: senkouA.toFixed(2),
                senkouB: senkouB.toFixed(2),
                signal: price > senkouA && price > senkouB ? 'BUY' : price < senkouA && price < senkouB ? 'SELL' : 'NEUTRAL'
            },
            pivotPoints: {
                pivot: pivot.toFixed(2),
                r1: r1.toFixed(2),
                r2: r2.toFixed(2),
                r3: r3.toFixed(2),
                s1: s1.toFixed(2),
                s2: s2.toFixed(2),
                s3: s3.toFixed(2)
            },
            fibonacci: {
                '0%': recentHigh.toFixed(2),
                '23.6%': fib236.toFixed(2),
                '38.2%': fib382.toFixed(2),
                '50%': fib50.toFixed(2),
                '61.8%': fib618.toFixed(2),
                '78.6%': fib786.toFixed(2),
                '100%': recentLow.toFixed(2)
            },
            volume: {
                current: volume,
                average: avgVolume,
                ratio: volumeRatio,
                signal: volumeRatio > 120 ? 'STRONG' : volumeRatio < 80 ? 'WEAK' : 'NORMAL'
            },
            volatility: {
                atr: atr.toFixed(2),
                atrPercent: atrPercent,
                signal: atrPercent > 0.5 ? 'HIGH' : atrPercent < 0.3 ? 'LOW' : 'NORMAL'
            },
            adx: {
                value: adx,
                plusDI: plusDI,
                minusDI: minusDI,
                trendStrength: adx > 25 ? 'STRONG' : adx > 20 ? 'MODERATE' : 'WEAK',
                signal: plusDI > minusDI ? 'BUY' : 'SELL'
            },
            patterns: patterns,
            sentiment: {
                bullPower: bullPower.toFixed(2),
                bearPower: bearPower.toFixed(2),
                fearGreedIndex: fearGreedIndex,
                signal: fearGreedIndex > 60 ? 'GREED' : fearGreedIndex < 40 ? 'FEAR' : 'NEUTRAL'
            }
        };
    }

    function detectPatterns(price, ema20, ema50, rsi) {
        const patterns = [];
        
        // Golden Cross
        if (ema20 > ema50 && Math.abs(ema20 - ema50) < 5) {
            patterns.push({
                name: 'Golden Cross',
                type: 'BULLISH',
                description: 'EMA20 v·ª´a c·∫Øt l√™n tr√™n EMA50 - T√≠n hi·ªáu tƒÉng m·∫°nh'
            });
        }
        
        // Death Cross
        if (ema20 < ema50 && Math.abs(ema20 - ema50) < 5) {
            patterns.push({
                name: 'Death Cross',
                type: 'BEARISH',
                description: 'EMA20 v·ª´a c·∫Øt xu·ªëng d∆∞·ªõi EMA50 - T√≠n hi·ªáu gi·∫£m m·∫°nh'
            });
        }
        
        // RSI Divergence
        if (rsi < 30) {
            patterns.push({
                name: 'RSI Oversold',
                type: 'BULLISH',
                description: `RSI ${rsi} - V√πng qu√° b√°n, c√≥ th·ªÉ ph·ª•c h·ªìi`
            });
        }
        
        if (rsi > 70) {
            patterns.push({
                name: 'RSI Overbought',
                type: 'BEARISH',
                description: `RSI ${rsi} - V√πng qu√° mua, c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh`
            });
        }
        
        // Trend Continuation
        if (price > ema20 && ema20 > ema50) {
            patterns.push({
                name: 'Strong Uptrend',
                type: 'BULLISH',
                description: 'Xu h∆∞·ªõng tƒÉng m·∫°nh, gi√° tr√™n c√°c MA ch√≠nh'
            });
        }
        
        if (price < ema20 && ema20 < ema50) {
            patterns.push({
                name: 'Strong Downtrend',
                type: 'BEARISH',
                description: 'Xu h∆∞·ªõng gi·∫£m m·∫°nh, gi√° d∆∞·ªõi c√°c MA ch√≠nh'
            });
        }
        
        return patterns;
    }

    function calculateTFData(price, tf) {
        let atr;
        switch(tf) {
            case 'M15': atr = 1.5; break;
            case 'H1': atr = 3; break;
            case 'H4': atr = 8; break;
            case 'D1': atr = 15; break;
        }
        
        const ema20 = price - (Math.random() - 0.5) * atr * 2;
        const ema50 = price - (Math.random() - 0.3) * atr * 3;
        const rsi = 35 + Math.floor(Math.random() * 30);
        
        const bullish = price > ema20 && ema20 > ema50;
        const bearish = price < ema20 && ema20 < ema50;
        
        const signal = bullish ? 'BUY' : bearish ? 'SELL' : 'NEUTRAL';
        const trend = bullish ? 'BULLISH' : bearish ? 'BEARISH' : 'NEUTRAL';
        const confidence = bullish || bearish ? 60 + Math.floor(Math.random() * 25) : 45 + Math.floor(Math.random() * 15);
        
        return {
            tf, atr: atr.toFixed(1), ema20: ema20.toFixed(2), ema50: ema50.toFixed(2),
            rsi, signal, trend, confidence
        };
    }

    function renderIndicators() {
        const tech = technicalData;
        
        // Oscillators
        let oscHTML = '';
        Object.entries(tech.oscillators).forEach(([key, data]) => {
            const badgeClass = data.signal === 'BUY' ? 'badge-buy' : data.signal === 'SELL' ? 'badge-sell' : 'badge-neutral';
            oscHTML += `
                <div class="indicator-item">
                    <div class="indicator-name">${key.toUpperCase()}</div>
                    <div class="indicator-value">
                        ${data.value}
                        <span class="signal-badge ${badgeClass}">${data.signal}</span>
                    </div>
                </div>
            `;
        });
        document.getElementById('oscillators').innerHTML = oscHTML;
        
        // Moving Averages
        let maHTML = '';
        Object.entries(tech.movingAverages).forEach(([key, data]) => {
            const badgeClass = data.signal === 'BUY' ? 'badge-buy' : 'badge-sell';
            maHTML += `
                <div class="indicator-item">
                    <div class="indicator-name">${key.toUpperCase()}</div>
                    <div class="indicator-value">
                        $${data.value}
                        <span class="signal-badge ${badgeClass}">${data.signal}</span>
                    </div>
                </div>
            `;
        });
        
        // Add Bollinger & Ichimoku
        maHTML += `
            <div class="indicator-item">
                <div class="indicator-name">BOLLINGER BANDS</div>
                <div class="indicator-value">
                    Position: ${tech.bollingerBands.position}%
                    <span class="signal-badge ${tech.bollingerBands.signal === 'BUY' ? 'badge-buy' : tech.bollingerBands.signal === 'SELL' ? 'badge-sell' : 'badge-neutral'}">${tech.bollingerBands.signal}</span>
                </div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">ICHIMOKU</div>
                <div class="indicator-value">
                    <span class="signal-badge ${tech.ichimoku.signal === 'BUY' ? 'badge-buy' : tech.ichimoku.signal === 'SELL' ? 'badge-sell' : 'badge-neutral'}">${tech.ichimoku.signal}</span>
                </div>
            </div>
        `;
        document.getElementById('movingAverages').innerHTML = maHTML;
        
        // Pivot & Fib
        let pivotHTML = `
            <div class="indicator-item">
                <div class="indicator-name">PIVOT POINT</div>
                <div class="indicator-value">$${tech.pivotPoints.pivot}</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">R1 / R2 / R3</div>
                <div class="indicator-value">$${tech.pivotPoints.r1} / $${tech.pivotPoints.r2} / $${tech.pivotPoints.r3}</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">S1 / S2 / S3</div>
                <div class="indicator-value">$${tech.pivotPoints.s1} / $${tech.pivotPoints.s2} / $${tech.pivotPoints.s3}</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">FIB 61.8%</div>
                <div class="indicator-value">$${tech.fibonacci['61.8%']}</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">FIB 50%</div>
                <div class="indicator-value">$${tech.fibonacci['50%']}</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">FIB 38.2%</div>
                <div class="indicator-value">$${tech.fibonacci['38.2%']}</div>
            </div>
        `;
        document.getElementById('pivotFib').innerHTML = pivotHTML;
        
        // Volume & Volatility
        let volHTML = `
            <div class="indicator-item">
                <div class="indicator-name">VOLUME</div>
                <div class="indicator-value">
                    ${(tech.volume.current / 1000000).toFixed(2)}M
                    <span class="signal-badge ${tech.volume.signal === 'STRONG' ? 'badge-strong' : tech.volume.signal === 'WEAK' ? 'badge-weak' : 'badge-neutral'}">${tech.volume.signal}</span>
                </div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">VOLUME RATIO</div>
                <div class="indicator-value">${tech.volume.ratio}%</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">ATR</div>
                <div class="indicator-value">$${tech.volatility.atr}</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">ATR %</div>
                <div class="indicator-value">
                    ${tech.volatility.atrPercent}%
                    <span class="signal-badge ${tech.volatility.signal === 'HIGH' ? 'badge-strong' : 'badge-neutral'}">${tech.volatility.signal}</span>
                </div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">ADX (Trend Strength)</div>
                <div class="indicator-value">
                    ${tech.adx.value}
                    <span class="signal-badge ${tech.adx.trendStrength === 'STRONG' ? 'badge-strong' : 'badge-neutral'}">${tech.adx.trendStrength}</span>
                </div>
            </div>
        `;
        document.getElementById('volumeVolatility').innerHTML = volHTML;
        
        // Chart Patterns
        let patternHTML = '';
        if (tech.patterns.length === 0) {
            patternHTML = '<p style="color:#666; text-align:center; padding:20px;">Kh√¥ng ph√°t hi·ªán pattern r√µ r√†ng</p>';
        } else {
            tech.patterns.forEach(p => {
                patternHTML += `
                    <div class="pattern-box">
                        <div class="pattern-name">${p.type === 'BULLISH' ? 'üìà' : 'üìâ'} ${p.name}</div>
                        <div class="pattern-desc">${p.description}</div>
                    </div>
                `;
            });
        }
        document.getElementById('chartPatterns').innerHTML = patternHTML;
        
        // Market Sentiment
        let sentHTML = `
            <div class="indicator-item">
                <div class="indicator-name">BULL POWER</div>
                <div class="indicator-value">${tech.sentiment.bullPower}</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">BEAR POWER</div>
                <div class="indicator-value">${tech.sentiment.bearPower}</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-name">FEAR & GREED INDEX</div>
                <div class="indicator-value">
                    ${tech.sentiment.fearGreedIndex}
                    <span class="signal-badge ${tech.sentiment.signal === 'GREED' ? 'badge-buy' : tech.sentiment.signal === 'FEAR' ? 'badge-sell' : 'badge-neutral'}">${tech.sentiment.signal}</span>
                </div>
            </div>
        `;
        document.getElementById('marketSentiment').innerHTML = sentHTML;
    }

    function renderTimeframes() {
        let html = '';
        Object.values(marketData).forEach(d => {
            const trendClass = d.trend === 'BULLISH' ? 'bullish' : d.trend === 'BEARISH' ? 'bearish' : '';
            const signalClass = d.signal === 'BUY' ? 'badge-buy' : d.signal === 'SELL' ? 'badge-sell' : 'badge-neutral';
            
            html += `
                <div class="tf-card ${trendClass}">
                    <div class="tf-header">
                        <div class="tf-name">${d.tf}</div>
                        <span class="signal-badge ${signalClass}">${d.signal}</span>
                    </div>
                    <div style="font-size:0.85em; color:#666; margin-top:5px;">
                        EMA20: $${d.ema20} | RSI: ${d.rsi} | Confidence: ${d.confidence}%
                    </div>
                </div>
            `;
        });
        document.getElementById('timeframeAnalysis').innerHTML = html;
    }

    function renderConfluence() {
        const signals = Object.values(marketData).map(d => d.signal);
        const buyCount = signals.filter(s => s === 'BUY').length;
        const sellCount = signals.filter(s => s === 'SELL').length;
        
        let score = 50;
        if (buyCount >= 3) {
            score = Math.floor(Object.values(marketData).reduce((sum, d) => sum + d.confidence, 0) / 4);
        } else if (sellCount >= 3) {
            score = Math.floor(Object.values(marketData).reduce((sum, d) => sum + d.confidence, 0) / 4);
        }
        
        document.getElementById('confluenceScore').textContent = score + '%';
        return score;
    }

    function renderSetups() {
        const conf = renderConfluence();
        const h4 = marketData.H4;
        const h1 = marketData.H1;
        const m15 = marketData.M15;
        
        let html = '';
        
        // High probability setup
        if (conf >= 65) {
            const buyCount = Object.values(marketData).filter(d => d.signal === 'BUY').length;
            const dir = buyCount >= 3 ? 'BUY' : 'SELL';
            const atr = parseFloat(h4.atr);
            const entry = currentPrice;
            const sl = dir === 'BUY' ? entry - atr * 2 : entry + atr * 2;
            const tp1 = dir === 'BUY' ? entry + atr * 3 : entry - atr * 3;
            const tp2 = dir === 'BUY' ? entry + atr * 5 : entry - atr * 5;
            
            html += `
                <div class="setup-card high">
                    <div class="setup-header">
                        <div class="setup-title">üî• HIGH PROBABILITY - ${dir}</div>
                        <div class="setup-confidence">${conf}%</div>
                    </div>
                    <div class="setup-details">
                        <div class="setup-item"><div class="setup-label">Entry</div><div class="setup-value">$${entry.toFixed(2)}</div></div>
                        <div class="setup-item"><div class="setup-label">Stop Loss</div><div class="setup-value">$${sl.toFixed(2)}</div></div>
                        <div class="setup-item"><div class="setup-label">TP1</div><div class="setup-value">$${tp1.toFixed(2)}</div></div>
                        <div class="setup-item"><div class="setup-label">TP2</div><div class="setup-value">$${tp2.toFixed(2)}</div></div>
                        <div class="setup-item"><div class="setup-label">R:R</div><div class="setup-value">1:2.5</div></div>
                    </div>
                </div>
            `;
        }
        
        // Medium setup
        if (h1.confidence >= 55) {
            const atr = parseFloat(h1.atr);
            const entry = currentPrice;
            const sl = h1.signal === 'BUY' ? entry - atr * 1.5 : entry + atr * 1.5;
            const tp = h1.signal === 'BUY' ? entry + atr * 3 : entry - atr * 3;
            
            html += `
                <div class="setup-card medium">
                    <div class="setup-header">
                        <div class="setup-title">üìä INTRADAY - ${h1.signal}</div>
                        <div class="setup-confidence">${h1.confidence}%</div>
                    </div>
                    <div class="setup-details">
                        <div class="setup-item"><div class="setup-label">Entry</div><div class="setup-value">$${entry.toFixed(2)}</div></div>
                        <div class="setup-item"><div class="setup-label">Stop Loss</div><div class="setup-value">$${sl.toFixed(2)}</div></div>
                        <div class="setup-item"><div class="setup-label">TP</div><div class="setup-value">$${tp.toFixed(2)}</div></div>
                        <div class="setup-item"><div class="setup-label">R:R</div><div class="setup-value">1:2</div></div>
                    </div>
                </div>
            `;
        }
        
        // Scalping setup
        const atr = parseFloat(m15.atr);
        const entry = currentPrice;
        html += `
            <div class="setup-card low">
                <div class="setup-header">
                    <div class="setup-title">‚ö° SCALPING - ${m15.signal}</div>
                    <div class="setup-confidence">${m15.confidence}%</div>
                </div>
                <div class="setup-details">
                    <div class="setup-item"><div class="setup-label">Entry</div><div class="setup-value">$${entry.toFixed(2)}</div></div>
                    <div class="setup-item"><div class="setup-label">Stop Loss</div><div class="setup-value">$${(entry - (m15.signal === 'BUY' ? atr : -atr)).toFixed(2)}</div></div>
                    <div class="setup-item"><div class="setup-label">TP</div><div class="setup-value">$${(entry + (m15.signal === 'BUY' ? atr * 2 : -atr * 2)).toFixed(2)}</div></div>
                    <div class="setup-item"><div class="setup-label">R:R</div><div class="setup-value">1:2</div></div>
                </div>
            </div>
        `;
        
        document.getElementById('entrySetups').innerHTML = html;
    }

    async function updatePrice() {
        currentPrice = await fetchPrice();
        
        document.getElementById('currentPrice').textContent = '$' + currentPrice.toFixed(2);
        document.getElementById('bidPrice').textContent = '$' + (currentPrice - 0.25).toFixed(2);
        document.getElementById('askPrice').textContent = '$' + (currentPrice + 0.25).toFixed(2);
        
        // Mock 24h change
        const change = (Math.random() - 0.5) * 50;
        const changePercent = (change / currentPrice * 100).toFixed(2);
        const changeText = (change >= 0 ? '+' : '') + change.toFixed(2) + ' (' + (changePercent >= 0 ? '+' : '') + changePercent + '%)';
        document.getElementById('priceChange').textContent = changeText;
        document.getElementById('priceChange').style.color = change >= 0 ? '#28a745' : '#dc3545';
        
        document.getElementById('updateTime').textContent = 'C·∫≠p nh·∫≠t: ' + new Date().toLocaleTimeString('vi-VN');
        
        // Calculate all indicators
        technicalData = calculateTechnicalIndicators(currentPrice);
        
        // Calculate timeframe data
        marketData = {
            M15: calculateTFData(currentPrice, 'M15'),
            H1: calculateTFData(currentPrice, 'H1'),
            H4: calculateTFData(currentPrice, 'H4'),
            D1: calculateTFData(currentPrice, 'D1')
        };
        
        renderIndicators();
        renderTimeframes();
        renderSetups();
    }

    function toggleJSON() {
        const preview = document.getElementById('jsonPreview');
        if (preview.style.display === 'none') {
            const fullData = {
                timestamp: new Date().toISOString(),
                symbol: 'XAU/USD',
                currentPrice: currentPrice,
                priceSource: priceSource,
                technicalIndicators: technicalData,
                multiTimeframeAnalysis: marketData,
                confluenceScore: renderConfluence()
            };
            
            preview.textContent = JSON.stringify(fullData, null, 2);
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    async function analyzeWithAI() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const provider = document.getElementById('aiProvider').value;
        
        if (!apiKey) {
            alert('Vui l√≤ng nh·∫≠p API Key!');
            return;
        }
        
        if (!currentPrice) {
            alert('Vui l√≤ng ƒë·ª£i d·ªØ li·ªáu t·∫£i xong!');
            return;
        }
        
        const btn = document.getElementById('aiAnalyzeBtn');
        const loading = document.getElementById('aiLoading');
        const response = document.getElementById('aiResponse');
        
        btn.disabled = true;
        loading.classList.add('show');
        response.classList.remove('show');
        
        const fullData = {
            timestamp: new Date().toISOString(),
            symbol: 'XAU/USD',
            currentPrice: currentPrice,
            priceSource: priceSource,
            technicalIndicators: technicalData,
            multiTimeframeAnalysis: marketData,
            confluenceScore: renderConfluence()
        };
        
        const prompt = `B·∫°n l√† chuy√™n gia ph√¢n t√≠ch k·ªπ thu·∫≠t XAU/USD. D∆∞·ªõi ƒë√¢y l√† d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß t·ª´ ph√¢n t√≠ch k·ªπ thu·∫≠t:
```

${JSON.stringify(fullData, null, 2)}

H√£y ph√¢n t√≠ch chi ti·∫øt v√† ƒë∆∞a ra:

1. **ƒê√ÅNH GI√Å XU H∆Ø·ªöNG T·ªîNG QUAN**
- Xu h∆∞·ªõng hi·ªán t·∫°i (bullish/bearish/sideways)
- ƒê·ªô m·∫°nh xu h∆∞·ªõng
- C√°c y·∫øu t·ªë h·ªó tr·ª£ xu h∆∞·ªõng n√†y
1. **PH√ÇN T√çCH C√ÅC CH·ªà B√ÅO K·ª∏ THU·∫¨T**
- Oscillators (RSI, Stochastic, CCI, etc.)
- Moving Averages alignment
- Bollinger Bands, Ichimoku
- Volume v√† Volatility
- ADX v√† trend strength
1. **CONFLUENCE ANALYSIS**
- ƒê√°nh gi√° ƒë·ªô tin c·∫≠y c·ªßa c√°c entry points
- Timeframes n√†o ƒëang align
- X√°c su·∫•t th√†nh c√¥ng c·ªßa setup hi·ªán t·∫°i
1. **ENTRY RECOMMENDATIONS**
- Entry price t·ªët nh·∫•t
- Stop Loss h·ª£p l√Ω
- Take Profit targets (TP1, TP2)
- Risk/Reward ratio
- Timeframe ph√π h·ª£p (scalping/intraday/swing)
1. **RISK MANAGEMENT**
- % v·ªën n√™n s·ª≠ d·ª•ng
- C·∫£nh b√°o r·ªßi ro
- ƒêi·ªÅu ki·ªán ƒë·ªÉ exit s·ªõm
1. **D·ª∞ ƒêO√ÅN NG·∫ÆN H·∫†N**
- 4-8 gi·ªù t·ªõi
- 1-3 ng√†y t·ªõi
- Key levels c·∫ßn ch√∫ √Ω

H√£y vi·∫øt b·∫±ng ti·∫øng Vi·ªát, chi ti·∫øt, th·ª±c t·∫ø v√† d·ªÖ hi·ªÉu cho trader.`;

```
        try {
            let apiResponse;
            
            if (provider === 'claude') {
                apiResponse = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-5-sonnet-20241022',
                        max_tokens: 4000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });
                
                if (!apiResponse.ok) {
                    const error = await apiResponse.json();
                    throw new Error(error.error?.message || 'API request failed');
                }
                
                const data = await apiResponse.json();
                response.textContent = data.content[0].text;
                
            } else if (provider === 'openai') {
                apiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [{
                            role: 'system',
                            content: 'B·∫°n l√† chuy√™n gia ph√¢n t√≠ch k·ªπ thu·∫≠t XAU/USD v·ªõi nhi·ªÅu nƒÉm kinh nghi·ªám.'
                        }, {
                            role: 'user',
                            content: prompt
                        }],
                        max_tokens: 4000
                    })
                });
                
                if (!apiResponse.ok) {
                    const error = await apiResponse.json();
                    throw new Error(error.error?.message || 'API request failed');
                }
                
                const data = await apiResponse.json();
                response.textContent = data.choices[0].message.content;
            }
            
            response.classList.add('show');
            console.log('‚úÖ AI analysis completed');
            
        } catch (error) {
            console.error('AI Analysis Error:', error);
            response.textContent = `‚ùå L·ªñI: ${error.message}\n\nVui l√≤ng ki·ªÉm tra:\n- API Key ƒë√∫ng ch∆∞a?\n- API Key c√≤n credits kh√¥ng?\n- K·∫øt n·ªëi internet ·ªïn ƒë·ªãnh kh√¥ng?`;
            response.classList.add('show');
        } finally {
            btn.disabled = false;
            loading.classList.remove('show');
        }
    }

    // Initialize
    window.addEventListener('load', () => {
        console.log('üéØ Advanced Technical Analysis Started');
        updatePrice();
        setInterval(updatePrice, 30000);
    });
</script>
```

</body>
</html>
