<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aura Entry Helper ‚Äî RSI14 + LWMA45 + EMA9 (on RSI)</title>
  <style>
    :root{ --bg:#0b1020;--card:#12162a;--muted:#9aa3b2;--text:#eef1f6;--accent:#7c5cff;--ok:#22c55e;--bad:#ef4444 }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:radial-gradient(120% 120% at 10% 0%,#1a1f37 0%,var(--bg) 55%);color:var(--text)}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand h1{font-size:18px;margin:0}
    .card{background:var(--card);border:1px solid #252a41;border-radius:16px;padding:14px}
    .grid{display:grid;grid-template-columns:1.5fr 1fr;gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted)}
    .row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .row2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .row3{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr;gap:10px}
    .row4{display:grid;grid-template-columns:1.4fr 1fr 1fr;gap:10px}
    select,input,button,textarea{width:100%;border-radius:12px;border:1px solid #2a3152;background:#0e1430;color:var(--text);padding:10px}
    button{cursor:pointer;font-weight:600}
    .btn{background:linear-gradient(180deg,#3b2fff, #6a58ff);border:none}
    .btn.secondary{background:#182042}
    .btn.ok{background:#204d2d}
    .btn.danger{background:#5a1f25}
    .hint{font-size:12px;color:var(--muted)}
    .tv-embed{height:560px;border-radius:12px;overflow:hidden}
    .mini{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;background:#141a36;border:1px solid #283058;font-size:12px}
    .pill.bad{border-color:#55333b;background:#2a1520;color:#ffb4b4}
    .pill.good{border-color:#2f5a3a;background:#183024;color:#b9f5c7}
    .signal{font-size:14px;line-height:1.55}
    .signal strong{color:#cbd5ff}
    .log{height:180px}
    .footer{margin-top:8px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .error{color:#ef9a9a;font-size:12px}
    .green{color:var(--ok)}
    .red{color:var(--bad)}
    kbd{background:#101633;border:1px solid #2b3256;border-radius:6px;padding:2px 6px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l3.09 6.26L22 9.27l-5 4.88L18.18 22 12 18.77 5.82 22 7 14.15l-5-4.88 6.91-1.01L12 2z" fill="#7c5cff"/></svg>
        <h1>Aura Entry Helper</h1>
      </div>
      <div class="mini">
        <span class="pill">TradingView + Binance API</span>
        <span class="pill">RSI14 + LWMA45 + EMA9</span>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="row3">
          <div>
            <label>Ngu·ªìn d·ªØ li·ªáu</label>
            <select id="market">
              <option value="binance" selected>Crypto (Binance)</option>
              <option value="stooq">FX / Gold (Stooq)</option>
            </select>
          </div>
          <div>
            <label>Quote filter</label>
            <select id="quote">
              <option value="">T·∫•t c·∫£</option>
              <option value="USDT" selected>USDT</option>
              <option value="FDUSD">FDUSD</option>
              <option value="USDC">USDC</option>
              <option value="BTC">BTC</option>
            </select>
          </div>
          <div>
            <label>T√¨m nhanh symbol</label>
            <input id="symSearch" placeholder="vd: BTC, ARB, MEME..." />
          </div>
          <div>
            <label>Symbol</label>
            <select id="symbol"></select>
          </div>
          <div>
            <label>T√¨nh tr·∫°ng</label>
            <div id="symCount" class="pill">Symbols: 0</div>
          </div>
        </div>

        <div class="row4" style="margin-top:10px">
          <div>
            <label>Custom proxy prefix (t√πy ch·ªçn)</label>
            <input id="customProxy" placeholder="vd: https://r.jina.ai/https:// (ƒë·ªÉ v∆∞·ª£t ch·∫∑n)" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="reloadSymbols" class="btn secondary">‚Üª Reload symbols</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="testProxies" class="btn secondary">üß™ Test proxies</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Khung th·ªùi gian</label>
            <select id="interval">
              <option value="5m">5m</option>
              <option value="15m">15m</option>
              <option value="1h" selected>1h</option>
              <option value="4h">4h</option>
              <option value="1d">1d</option>
            </select>
          </div>
          <div>
            <label>ATR period</label>
            <input id="atrPeriod" type="number" min="2" value="14" />
          </div>
          <div>
            <label>ATR SL multiplier</label>
            <input id="atrSL" type="number" step="0.1" value="1.5" />
          </div>
          <div>
            <label>TP : SL (R:R)</label>
            <input id="rr" type="number" step="0.1" value="2.0" />
          </div>
          <div>
            <label>Resample 4h (FX)</label>
            <select id="resample4h">
              <option value="on" selected>B·∫≠t (t·ª´ 60m ‚Üí 4h)</option>
              <option value="off">T·∫Øt (d√πng 60m)</option>
            </select>
          </div>
        </div>

        <div id="tvWidget" class="tv-embed"></div>
        <div id="err" class="error"></div>
        <div class="footer">
          <div class="hint" id="dsHint">D·ªØ li·ªáu ph√¢n t√≠ch l·∫•y t·ª´ Binance.</div>
          <div class="mini">
            <button id="refresh" class="btn secondary">‚Üª T·∫£i d·ªØ li·ªáu</button>
            <button id="auto" class="btn">Ph√¢n t√≠ch & G·ª£i √Ω</button>
          </div>
          <div id="apiStatus" class="pill bad" style="display:none"></div>
        </div>
      </section>

      <aside class="card">
        <h3 style="margin:6px 0 8px 0">G·ª£i √Ω m·ªü l·ªánh</h3>
        <div class="row2">
          <button class="btn ok" id="btnLong">G·ª£i √Ω BUY (Long)</button>
          <button class="btn danger" id="btnShort">G·ª£i √Ω SELL (Short)</button>
        </div>
        <p class="hint" style="margin-top:8px">Logic: EMA9(RSI) cross/trend v·ªõi LWMA45(RSI) + SL theo ATR, TP theo R:R.</p>
        <div id="signal" class="signal" style="margin-top:10px"></div>
        <div class="row2" style="margin-top:10px">
          <button id="copy" class="btn secondary">Copy t√≠n hi·ªáu</button>
          <button id="clear" class="btn secondary">X√≥a</button>
        </div>

        <hr style="border-color:#2b3256;margin:14px 0">
        <label for="openaiKey">(Tu·ª≥ ch·ªçn) OpenAI API Key</label>
        <input id="openaiKey" type="password" placeholder="sk-... (ƒëi·ªÅn n·∫øu mu·ªën AI gi·∫£i th√≠ch)"/>
        <button id="askAI" class="btn" style="margin-top:8px">Nh·ªù AI gi·∫£i th√≠ch setup</button>
        <textarea id="aiOut" class="log" placeholder="Gi·∫£i th√≠ch s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y" readonly></textarea>
        <p class="hint">Kh√¥ng l∆∞u key. Key ch·ªâ d√πng trong tr√¨nh duy·ªát c·ªßa b·∫°n.</p>
      </aside>
    </div>

    <p class="hint" style="margin-top:10px">M·∫πo: b·∫•m <kbd>A</kbd> ƒë·ªÉ ph√¢n t√≠ch nhanh, <kbd>L</kbd> ƒë·ªÉ BUY, <kbd>S</kbd> ƒë·ªÉ SELL.</p>

  </div>

  <!-- TradingView Widget -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <script>
    // ====== Helpers ======
    const $ = (id)=>document.getElementById(id);
    const fmt = (x, d=2)=> Number(x).toFixed(d);
    const toBinanceInt = (v)=>({"5m":"5m","15m":"15m","1h":"1h","4h":"4h","1d":"1d"}[v]||"15m");
    const toTVInt = (v)=>({"5m":"5","15m":"15","1h":"60","4h":"240","1d":"D"}[v]||"15");
    const toStooqInt = (v)=>({"5m":"5","15m":"15","1h":"60","4h":"60","1d":"d"}[v]||"15");

    function tvSymbolFor(market,sym){
      if(market==='binance') return 'BINANCE:'+sym;
      const map = {
        'XAUUSD':'FX_IDC:XAUUSD','XAGUSD':'FX_IDC:XAGUSD',
        'EURUSD':'FX:EURUSD','GBPUSD':'FX:GBPUSD','USDJPY':'FX:USDJPY','AUDUSD':'FX:AUDUSD','USDCAD':'FX:USDCAD','NZDUSD':'FX:NZDUSD','USDCHF':'FX:USDCHF'
      };
      return map[sym]||'FX:'+sym;
    }
    function createTV(sym, intv){
      const market = $("market").value;
      const el = $("tvWidget");
      el.innerHTML = "";
      new TradingView.widget({
        autosize: true,
        symbol: tvSymbolFor(market, sym),
        interval: toTVInt(intv),
        timezone: "Asia/Ho_Chi_Minh",
        theme: "dark",
        style: "1",
        container_id: "tvWidget",
        withdateranges: true,
        hide_side_toolbar: false,
        allow_symbol_change: true,
        studies: ["RSI@tv-basicstudies","ATR@tv-basicstudies"],
      });
    }

    async function fetchJSON(u, timeoutMs=9000){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const r = await fetch(u, {signal: ctrl.signal});
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.json();
      } finally { clearTimeout(t); }
    }
    async function fetchTEXT(u, timeoutMs=9000){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const r = await fetch(u, {signal: ctrl.signal});
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.text();
      } finally { clearTimeout(t); }
    }

    function withCustomProxy(u){
      const p = $("customProxy").value.trim();
      if(!p) return u;
      if(p.endsWith('/') && u.startsWith('http')) return p + u;
      if(!p.endsWith('/') && u.startsWith('http')) return p + '/' + u;
      return p + u;
    }

    // ====== Binance exchangeInfo with fallbacks ======
    let BINANCE_SYMBOLS_ALL = [];
    let BINANCE_SOURCE = 'api';
    const STOOQ_SYMBOLS = ['XAUUSD','XAGUSD','EURUSD','GBPUSD','USDJPY','AUDUSD','USDCAD','NZDUSD','USDCHF'];

    async function fetchBinanceSymbols(){
      BINANCE_SOURCE = 'api';
      $("apiStatus").style.display = 'none';
      const bases = [
        'https://api.binance.com/api/v3/exchangeInfo',
        'https://api1.binance.com/api/v3/exchangeInfo',
        'https://api2.binance.com/api/v3/exchangeInfo',
        'https://api3.binance.com/api/v3/exchangeInfo',
        'https://data-api.binance.vision/api/v3/exchangeInfo',
      ];
      const wrappers = (u)=>[
        u,
        'https://cors.isomorphic-git.org/'+u,
        'https://api.allorigins.win/raw?url='+encodeURIComponent(u),
        'https://r.jina.ai/https://'+u.replace(/^https?:\/\//,''),
        'https://r.jina.ai/http://'+u.replace(/^https?:\/\//,''),
        withCustomProxy(u),
      ];
      const attempts = [];
      for(const b of bases){ attempts.push(...wrappers(b)); }

      for(const u of attempts){
        try{
          let data;
          if(u.includes('r.jina.ai') || u.includes('allorigins') || u.includes('isomorphic-git') || u===withCustomProxy(u)){
            const txt = await fetchTEXT(u);
            try{ data = JSON.parse(txt); }catch{ data = null; }
          }else{
            data = await fetchJSON(u);
          }
          const list = (data?.symbols||[])
            .filter(s => s.status === 'TRADING' && Array.isArray(s.permissions) && s.permissions.includes('SPOT'))
            .map(s => s.symbol);
          if(list && list.length > 50){
            BINANCE_SYMBOLS_ALL = list.sort();
            updateCountBadge();
            return {ok:true, url:u, count:list.length};
          }
        }catch(e){ /* try next */ }
      }
      // Fallback
      BINANCE_SOURCE = 'fallback';
      BINANCE_SYMBOLS_ALL = ['BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT','DOGEUSDT','ADAUSDT','AVAXUSDT','DOTUSDT','LINKUSDT'];
      $("apiStatus").textContent = 'ƒêang d√πng danh s√°ch fallback (API b·ªã ch·∫∑n). B·∫°n c√≥ th·ªÉ nh·∫≠p "Custom proxy prefix" v√≠ d·ª•: https://r.jina.ai/https://';
      $("apiStatus").className = 'pill bad';
      $("apiStatus").style.display = 'inline-block';
      updateCountBadge();
      return {ok:false};
    }

    // ====== Klines ======
    async function fetchKlines(symbol, interval, limit=500){
      const market = $("market").value;
      if(market==='binance'){
        const bases = [
          `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`,
          `https://api1.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`,
          `https://api2.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`,
          `https://api3.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`,
          `https://data-api.binance.vision/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`,
        ];
        const wrappers = (u)=>[
          u,
          'https://cors.isomorphic-git.org/'+u,
          'https://api.allorigins.win/raw?url='+encodeURIComponent(u),
          'https://r.jina.ai/https://'+u.replace(/^https?:\/\//,''),
          'https://r.jina.ai/http://'+u.replace(/^https?:\/\//,''),
          withCustomProxy(u),
        ];
        const attempts = [];
        for(const b of bases){ attempts.push(...wrappers(b)); }
        for(const u of attempts){
          try{
            let raw;
            if(u.includes('r.jina.ai') || u.includes('allorigins') || u.includes('isomorphic-git') || u===withCustomProxy(u)){
              const txt = await fetchTEXT(u);
              try{ raw = JSON.parse(txt); }catch{ raw = null; }
            }else{
              raw = await fetchJSON(u);
            }
            if(Array.isArray(raw) && raw.length){
              return raw.map(k=>({time:Math.floor(k[0]/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4]}));
            }
          }catch(e){}
        }
        throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu n·∫øn (Binance).');
      } else {
        const stooqSym = symbol.toLowerCase();
        const i = toStooqInt(interval);
        const base = `https://stooq.com/q/d/l/?s=${stooqSym}&i=${i}`;
        const attempts = [
          base,
          `https://cors.isomorphic-git.org/${base}`,
          `https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`,
          `https://r.jina.ai/http://stooq.com/q/d/l/?s=${stooqSym}&i=${i}`,
          `https://r.jina.ai/https://stooq.com/q/d/l/?s=${stooqSym}&i=${i}`,
        ];
        const parseCSV = (txt) => {
          const lines = txt.trim().split(/\n+/);
          if(lines.length < 2) return [];
          const head = lines[0].toLowerCase();
          const rows = lines.slice(1);
          return rows.map(line=>{
            const parts = line.split(',');
            let d,t,o,h,l,c;
            if(head.includes('time')){ [d,t,o,h,l,c] = parts; }
            else { [d,o,h,l,c] = parts; t = '00:00:00'; }
            const ts = Date.parse(`${d}T${t}Z`);
            return { time: Math.floor(ts/1000), open:+o, high:+h, low:+l, close:+c };
          }).filter(v=>isFinite(v.time) && isFinite(v.open));
        };
        for(const u of attempts){
          try{
            const txt = await fetchTEXT(u);
            let data = parseCSV(txt).slice(-limit);
            if(interval==='4h' && $("resample4h").value==='on' && i==='60'){
              data = resampleCandles(data, 4*60*60);
            }
            if(data.length) return data;
          }catch(e){}
        }
        try{
          const dailyBase = `https://stooq.com/q/d/l/?s=${stooqSym}&i=d`;
          const alt = [
            dailyBase,
            `https://cors.isomorphic-git.org/${dailyBase}`,
            `https://api.allorigins.win/raw?url=${encodeURIComponent(dailyBase)}`,
            `https://r.jina.ai/https://stooq.com/q/d/l/?s=${stooqSym}&i=d`
          ];
          for(const u of alt){
            try{
              const txt = await fetchTEXT(u);
              const data = parseCSV(txt).slice(-limit);
              if(data.length) return data;
            }catch(e){}
          }
        }catch(e){}
        throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu n·∫øn (Stooq).');
      }
    }

    // ====== Indicators ======
    function ema(values, period){ const k=2/(period+1); let prev=values[0]; const out=[prev]; for(let i=1;i<values.length;i++){ const v=values[i]*k+prev*(1-k); out.push(v); prev=v;} return out; }
    function rsi(closes, period){
      const g=[],l=[];
      for(let i=1;i<closes.length;i++){const d=closes[i]-closes[i-1]; g.push(Math.max(0,d)); l.push(Math.max(0,-d));}
      const eg=ema([g[0],...g],period), el=ema([l[0],...l],period);
      const rs=eg.map((v,i)=>v/(el[i]||1e-9));
      return rs.map(v=>100-100/(1+v));
    }
    function atr(c, p){
      const t=[];
      for(let i=0;i<c.length;i++){
        if(i===0){t.push(c[i].high-c[i].low);continue;}
        const h=c[i].high,l=c[i].low,pc=c[i-1].close;
        t.push(Math.max(h-l,Math.abs(h-pc),Math.abs(l-pc)));
      }
      return ema(t,p);
    }
    function lwma(values, period){
      const out = new Array(values.length).fill(NaN);
      const denom = period*(period+1)/2;
      for(let i=period-1;i<values.length;i++){
        let sum=0; let w=1;
        for(let j=i-period+1;j<=i;j++) sum += values[j]*w++;
        out[i]= sum/denom;
      }
      for(let k=0;k<period-1;k++){ out[k] = values[k]; }
      return out;
    }
    function resampleCandles(data, stepSec){
      if(!data?.length) return [];
      const out=[]; let bucket=null;
      for(const c of data){
        const t = Math.floor(c.time/stepSec)*stepSec;
        if(!bucket || bucket.time!==t){
          if(bucket) out.push(bucket);
          bucket = {time:t, open:c.open, high:c.high, low:c.low, close:c.close};
        }else{
          bucket.high = Math.max(bucket.high, c.high);
          bucket.low  = Math.min(bucket.low, c.low);
          bucket.close= c.close;
        }
      }
      if(bucket) out.push(bucket);
      return out;
    }

    // ====== Symbol list & UI ======
    function filterBinanceSymbols(){
      const q = $("quote").value.trim();
      const search = $("symSearch").value.trim().toUpperCase();
      let arr = BINANCE_SYMBOLS_ALL;
      if(q) arr = arr.filter(s => s.endsWith(q));
      if(search) arr = arr.filter(s => s.includes(search));
      return arr;
    }
    function populateSymbols(){
      const sel = $("symbol");
      sel.innerHTML = '';
      const market = $("market").value;
      let arr = [];
      if(market==='binance'){
        arr = filterBinanceSymbols();
      }else arr = STOOQ_SYMBOLS;
      for(const s of arr){
        const opt=document.createElement('option'); opt.textContent=s; opt.value=s; sel.appendChild(opt);
      }
      if(arr.length) sel.value = arr[0];
      $("dsHint").textContent = market==='binance' ? 'D·ªØ li·ªáu ph√¢n t√≠ch l·∫•y t·ª´ Binance (symbol t·ª± ƒë·ªông c·∫≠p nh·∫≠t).' : 'D·ªØ li·ªáu ph√¢n t√≠ch l·∫•y t·ª´ Stooq (qua proxy).';
      updateCountBadge();
    }
    function updateCountBadge(){
      const count = ($("market").value==='binance') ? filterBinanceSymbols().length : STOOQ_SYMBOLS.length;
      const el = $("symCount");
      el.textContent = `Symbols: ${count}`;
      el.className = BINANCE_SOURCE==='api' ? 'pill good' : 'pill bad';
    }

    // ====== Analysis state ======
    let candles=[], lastSignalText='', lastAnalysis=null;

    async function load(){
      $("err").textContent='';
      if($("market").value==='binance' && BINANCE_SYMBOLS_ALL.length===0){
        await fetchBinanceSymbols();
      }
      if($("symbol").options.length===0) populateSymbols();

      const sym = $("symbol").value?.trim();
      if(!sym){ $("err").textContent='Kh√¥ng c√≥ symbol ƒë·ªÉ t·∫£i.'; return; }
      const intv = $("interval").value;
      createTV(sym, intv);
      try{
        const fetchIntv = $("market").value==='binance'? toBinanceInt(intv): intv;
        candles = await fetchKlines(sym, fetchIntv, 600);
      }catch(e){ $("err").textContent = 'L·ªói d·ªØ li·ªáu: '+e.message; }
    }

    function analyzeRSI(direction){
      if(candles.length<60){ $("signal").innerHTML='<span class="red">D·ªØ li·ªáu qu√° √≠t ƒë·ªÉ ph√¢n t√≠ch.</span>'; return; }
      const closes = candles.map(c=>c.close);
      const baseRSI = rsi(closes, 14);
      const emaRSI9  = ema(baseRSI, 9);
      const lwmaRSI45 = lwma(baseRSI, 45);
      const at = atr(candles, Math.max(2, +$("atrPeriod").value|0));
      const n = closes.length-1;
      const price = closes[n];
      const rsiV  = baseRSI[n]||50;
      const vol   = at[n]||0;

      const crossUp = emaRSI9[n-1] <= lwmaRSI45[n-1] && emaRSI9[n] > lwmaRSI45[n];
      const crossDn = emaRSI9[n-1] >= lwmaRSI45[n-1] && emaRSI9[n] < lwmaRSI45[n];
      const trendUp = emaRSI9[n] > lwmaRSI45[n];
      const trendDn = emaRSI9[n] < lwmaRSI45[n];

      let ok=false, sl=0, tp=0, why=[];
      if(direction==='long'){
        ok = (crossUp || trendUp) && rsiV > 45;
        sl = price - +$("atrSL").value * vol;
        tp = price + (+$("rr").value * (price - sl));
        if(crossUp) why.push('EMA9(RSI) c·∫Øt LWMA45(RSI) ƒëi l√™n');
        if(trendUp) why.push('EMA9(RSI) > LWMA45(RSI)');
        why.push(`RSI14=${fmt(rsiV,1)}`);
      } else {
        ok = (crossDn || trendDn) && rsiV < 55;
        sl = price + +$("atrSL").value * vol;
        tp = price - (+$("rr").value * (sl - price));
        if(crossDn) why.push('EMA9(RSI) c·∫Øt LWMA45(RSI) ƒëi xu·ªëng');
        if(trendDn) why.push('EMA9(RSI) < LWMA45(RSI)');
        why.push(`RSI14=${fmt(rsiV,1)}`);
      }

      const sym=$("symbol").value, intv=$("interval").value; 
      const status= ok?'<span class="green">PH√ô H·ª¢P</span>':'<span class="red">CH∆ØA PH√ô H·ª¢P</span>';
      const text=`
‚Äî G·ª£i √Ω ${direction==='long'?'BUY':'SELL'} (${sym} ¬∑ ${intv}) ‚Äî
Entry: ${fmt(price)}
SL: ${fmt(sl)}  (ATRx${$("atrSL").value})
TP: ${fmt(tp)}  (R:R ${$("rr").value})
ƒêi·ªÅu ki·ªán: ${why.join(' ¬∑ ')}
C·∫•u h√¨nh: RSI14 + LWMA45(RSI) + EMA9(RSI)
K·∫øt lu·∫≠n: ${ok?'N√äN CH·ªú PULLBACK HO·∫∂C V√ÄO V·ªä TH·∫æ NH·∫∏':'Quan s√°t th√™m, ƒë·ª£i x√°c nh·∫≠n'}
`;
      lastSignalText=text.trim();

      lastAnalysis = {
        symbol: $("symbol").value,
        interval: $("interval").value,
        market: $("market").value,
        entry: +fmt(price),
        sl: +fmt(sl),
        tp: +fmt(tp),
        rr: +$("rr").value,
        atrPeriod: Math.max(2, +$("atrPeriod").value|0),
        atrSLmult: +$("atrSL").value,
        rsi14: +fmt(rsiV,1),
        ema9_gt_lwma45: emaRSI9[n] > lwmaRSI45[n],
        crossUp, crossDn, trendUp, trendDn,
        lastBarTime: candles[n]?.time || null,
        notes: lastSignalText
      };

      $("signal").innerHTML=`<strong>K·∫øt qu·∫£:</strong> ${status}<br><br><pre style="white-space:pre-wrap">${text}</pre>`;
    }

    // ====== UI Events ======
    $("reloadSymbols").onclick = async ()=>{
      BINANCE_SYMBOLS_ALL = [];
      await fetchBinanceSymbols();
      populateSymbols();
    };
    $("testProxies").onclick = async ()=>{
      $("apiStatus").style.display = 'inline-block';
      $("apiStatus").className = 'pill';
      $("apiStatus").textContent = 'ƒêang test...';
      const r = await fetchBinanceSymbols();
      if(r?.ok){
        $("apiStatus").className = 'pill good';
        $("apiStatus").textContent = `OK: ${r.count} symbols ‚Ä¢ ${r.url}`;
      }else{
        $("apiStatus").className = 'pill bad';
        $("apiStatus").textContent = 'Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c API. ƒêang d√πng fallback. B·∫°n h√£y nh·∫≠p "Custom proxy prefix".';
      }
      populateSymbols();
    };
    $("refresh").onclick=load;
    $("auto").onclick = async () => {
      try{
        $("err").textContent='';
        if(!candles.length) await load();
        if(!candles.length){ $("err").textContent='Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch.'; return; }
        const closes = candles.map(c=>c.close);
        if(closes.length<60){
          $("signal").innerHTML='<span class="red">D·ªØ li·ªáu qu√° √≠t (c·∫ßn ‚â• 60 n·∫øn). H√£y ch·ªçn khung th·ªùi gian l·ªõn h∆°n ho·∫∑c th·ª≠ l·∫°i.</span>';
          return;
        }
        const baseRSI = rsi(closes, 14);
        const emaRSI9 = ema(baseRSI, 9);
        const lwmaRSI45 = lwma(baseRSI, 45);
        const n = closes.length-1;
        if(!isFinite(emaRSI9[n]) || !isFinite(lwmaRSI45[n])){
          $("err").textContent='Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ t√≠nh RSI/EMA/LWMA.';
          return;
        }
        const dir = (emaRSI9[n] >= lwmaRSI45[n]) ? 'long' : 'short';
        analyzeRSI(dir);
      }catch(e){
        $("err").textContent = 'L·ªói Auto Analyze: '+ e.message;
      }
    };
    $("btnLong").onclick=()=>analyzeRSI('long');
    $("btnShort").onclick=()=>analyzeRSI('short');
    $("clear").onclick=()=>{ $("signal").innerHTML=''; lastSignalText=''; lastAnalysis=null; };
    $("copy").onclick=()=>{ if(!lastSignalText) return; navigator.clipboard.writeText(lastSignalText); };
    $("symSearch").addEventListener('input', ()=>{ populateSymbols(); });
    $("quote").addEventListener('change', ()=>{ populateSymbols(); });
    $("market").addEventListener('change', async ()=>{
      if($("market").value==='binance' && BINANCE_SYMBOLS_ALL.length===0){
        await fetchBinanceSymbols();
      }
      populateSymbols();
      load();
    });
    $("symbol").addEventListener('change', load);
    $("interval").addEventListener('change', load);
    $("resample4h").addEventListener('change', load);

    // ====== OpenAI Explain (fully wired) ======
    function buildAIPrompt() {
      if (!lastAnalysis || !lastSignalText) {
        return "Kh√¥ng c√≥ t√≠n hi·ªáu/ph√¢n t√≠ch n√†o. H√£y b·∫•m 'Ph√¢n t√≠ch & G·ª£i √Ω' tr∆∞·ªõc.";
      }
      const a = lastAnalysis;
      return `
B·∫°n l√† tr·ª£ l√Ω giao d·ªãch. H√£y gi·∫£i th√≠ch r√µ r√†ng setup v·ª´a ph√¢n t√≠ch:

T√ìM T·∫ÆT:
${lastSignalText}

CHI TI·∫æT TH√îNG S·ªê:
- Symbol: ${a.symbol} (${a.market})
- Khung th·ªùi gian: ${a.interval}
- RSI14 hi·ªán t·∫°i: ${a.rsi14}
- EMA9(RSI) ${a.ema9_gt_lwma45 ? '>' : '<='} LWMA45(RSI)
- CrossUp: ${a.crossUp}, CrossDown: ${a.crossDn}, TrendUp: ${a.trendUp}, TrendDown: ${a.trendDn}
- Entry: ${a.entry}
- SL (ATR x ${a.atrSLmult}, p=${a.atrPeriod}): ${a.sl}
- TP (R:R ${a.rr}): ${a.tp}
- Th·ªùi ƒëi·ªÉm n·∫øn cu·ªëi: ${a.lastBarTime ? new Date(a.lastBarTime*1000).toISOString() : 'N/A'}

Y√äU C·∫¶U:
1) Gi·∫£i th√≠ch v√¨ sao ra k·∫øt lu·∫≠n tr√™n (d·ª±a v√†o EMA9(RSI) vs LWMA45(RSI), ng∆∞·ª°ng RSI14).
2) G·ª£i √Ω c√°ch v√†o l·ªánh (market hay pullback), ƒë·∫∑t SL/TP theo ATR v√† R:R n√™u tr√™n.
3) N√™u r·ªßi ro v√† ƒëi·ªÅu ki·ªán v√¥ hi·ªáu (invalidation).
4) Ng·∫Øn g·ªçn, t·ª´ng √Ω r√µ r√†ng (g·∫°ch ƒë·∫ßu d√≤ng).
`.trim();
    }

    async function callOpenAIExplain(key, prompt) {
      const url = "https://api.openai.com/v1/chat/completions";
      const body = {
        model: "gpt-4o-mini",
        temperature: 0.3,
        messages: [
          { role: "system", content: "B·∫°n l√† tr·ª£ l√Ω giao d·ªãch th·∫≠n tr·ªçng, gi·∫£i th√≠ch s√∫c t√≠ch, c√≥ c·∫•u tr√∫c, tr√°nh ph√≥ng ƒë·∫°i." },
          { role: "user",   content: prompt }
        ]
      };
      const r = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${key}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      if (!r.ok) {
        let detail=""; try{ detail=await r.text(); }catch{}
        throw new Error(`OpenAI API l·ªói HTTP ${r.status}${detail ? ` ‚Äî ${detail}` : ""}`);
      }
      const data = await r.json();
      const text = data?.choices?.[0]?.message?.content?.trim();
      if (!text) throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung ph·∫£n h·ªìi t·ª´ OpenAI.");
      return text;
    }

    $("askAI").onclick = async () => {
      const key = $("openaiKey").value.trim();
      const out = $("aiOut");
      out.value = "";
      $("err").textContent = "";

      if (!key || !/^sk-/.test(key)) {
        $("err").textContent = "Vui l√≤ng nh·∫≠p OpenAI API Key h·ª£p l·ªá (b·∫Øt ƒë·∫ßu b·∫±ng sk-...).";
        return;
      }
      if (!lastAnalysis || !lastSignalText) {
        $("err").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu ph√¢n t√≠ch. H√£y b·∫•m 'Ph√¢n t√≠ch & G·ª£i √Ω' tr∆∞·ªõc.";
        return;
      }
      const btn = $("askAI");
      btn.disabled = true; btn.textContent = "ƒêang h·ªèi AI...";
      try {
        const prompt = buildAIPrompt();
        const answer = await callOpenAIExplain(key, prompt);
        out.value = answer;
      } catch (e) {
        out.value = "";
        $("err").textContent = "OpenAI error: " + (e?.message || e);
      } finally {
        btn.disabled = false; btn.textContent = "Nh·ªù AI gi·∫£i th√≠ch setup";
      }
    };

    // ====== Keyboard shortcuts ======
    window.addEventListener('keydown', (e)=>{
      if (e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      if(e.key==='a' || e.key==='A'){ $("auto").click(); }
      if(e.key==='l' || e.key==='L'){ $("btnLong").click(); }
      if(e.key==='s' || e.key==='S'){ $("btnShort").click(); }
    });

    // ====== Self-tests & init ======
    function runSelfTests(){
      const out=[];
      try{
        const sampleCSV = 'Date,Time,Open,High,Low,Close,Volume\n2025-10-11,09:00:00,1,2,0.5,1.5,10\n2025-10-11,09:05:00,1.5,2.5,1.0,2.0,12\n';
        const lines = sampleCSV.trim().split(/\n+/);
        out.push(`[OK] Regex split lines=${lines.length}`);
        const arr=[1,2,3,4,5];
        const lw = lwma(arr,3);
        out.push(`[OK] LWMA last=${lw[4].toFixed(6)} (expect ~4.333333)`);
        const r = rsi([1,1,1,1,1],14);
        out.push(`[OK] RSI flat last=${r[r.length-1].toFixed(2)} (impl-specific)`);
      }catch(e){ out.push('[ERR] Self-test: '+e.message); }
      console.log('Self-tests:', out.join('\n'));
    }

    window.addEventListener('load', async ()=>{
      await fetchBinanceSymbols();
      populateSymbols();
      await load();
      runSelfTests();
    });
  </script>
</body>
</html>
