<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Phân tích XAU/USD — Live</title>
<style>
  :root{
    --bg:#f8fbff; --card:#ffffff; --muted:#667085;
    --accent:#0b76ef; --success:#16a34a; --danger:#ef4444;
    --glass: rgba(255,255,255,0.7);
  }
  body{font-family:Inter,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#f8fbff, #ffffff); margin:0; color:#0f1724;}
  .wrap{max-width:1100px;margin:28px auto;padding:20px;}
  header{display:flex;align-items:center;gap:16px;margin-bottom:18px;}
  .logo{width:64px;height:64px;border-radius:10px;background:linear-gradient(135deg,#ffffff, #e6f2ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);box-shadow:0 6px 18px rgba(10,40,90,0.06)}
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(15,23,36,0.04)}
  .price-panel{text-align:center}
  .price{font-size:32px;font-weight:700;color:#08123a}
  .chg{font-size:13px;color:var(--muted);margin-top:6px}
  .small{font-size:12px;color:var(--muted)}
  .timeframe-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .tf{padding:6px 10px;border-radius:8px;background:var(--glass);cursor:pointer;font-weight:600;font-size:13px}
  .tf.active{background:linear-gradient(90deg,var(--accent),#1e90ff);color:white}
  .analysis {display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
  .entry{padding:10px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}
  .entry h3{margin:0;font-size:14px}
  .vals{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .pill{background:#f1f6ff;padding:8px 10px;border-radius:8px;font-weight:700}
  .controls{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  label{font-size:12px;color:var(--muted)}
  input[type="text"], input[type="number"], select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef9;background:#fbfeff}
  button{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:white;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid #d7e9ff;color:var(--accent)}
  .footer-note{font-size:12px;color:var(--muted);margin-top:10px}
  .analysis-text{font-size:13px;color:#0b1220;line-height:1.45}
  .disclaimer{font-size:12px;color:var(--muted);margin-top:8px}
  pre {background:#f3f7ff;padding:10px;border-radius:8px;overflow:auto;font-size:12px}
  @media (max-width:920px){.grid{grid-template-columns:1fr}.analysis{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">XAU</div>
    <div>
      <h1>Phân tích XAU/USD theo giá thực</h1>
      <p class="lead">Phân tích đa khung thời gian — Scalping & Swing — gợi ý entry / SL / TP. <span class="small">Cập nhật giá theo thời gian thực (cần API key của nhà cung cấp dữ liệu giá).</span></p>
    </div>
  </header>

  <div class="grid">
    <!-- left column: price + controls -->
    <div class="card">
      <div class="price-panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:12px;color:var(--muted)">Mã</div>
            <div style="font-weight:800;font-size:16px">XAU / USD</div>
          </div>
          <div style="text-align:right">
            <div class="small">Cập nhật:</div>
            <div id="lastUpdated" class="small">--</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div id="price" class="price">--</div>
          <div id="priceChange" class="chg">--</div>
        </div>

        <div class="timeframe-row" id="timeframes">
          <div class="tf active" data-tf="1min">1m</div>
          <div class="tf" data-tf="5min">5m</div>
          <div class="tf" data-tf="15min">15m</div>
          <div class="tf" data-tf="1h">1h</div>
          <div class="tf" data-tf="4h">4h</div>
          <div class="tf" data-tf="1d">1d</div>
        </div>

        <div class="analysis" style="margin-top:14px">
          <div class="entry">
            <h3>Scalping (ngắn)</h3>
            <div class="vals">
              <div class="pill">Entry: <span id="scalp-entry">--</span></div>
              <div class="pill">SL: <span id="scalp-sl">--</span></div>
              <div class="pill">TP: <span id="scalp-tp">--</span></div>
            </div>
            <div class="disclaimer" id="scalp-note">--</div>
          </div>

          <div class="entry">
            <h3>Swing (trung/dài)</h3>
            <div class="vals">
              <div class="pill">Entry: <span id="swing-entry">--</span></div>
              <div class="pill">SL: <span id="swing-sl">--</span></div>
              <div class="pill">TP: <span id="swing-tp">--</span></div>
            </div>
            <div class="disclaimer" id="swing-note">--</div>
          </div>

          <div style="grid-column:1 / -1; margin-top:10px">
            <div style="display:flex;gap:10px;align-items:center">
              <div style="flex:1">
                <label>API Cung cấp Giá (Metals-API / AlphaVantage / ...)</label>
                <input id="priceApiKey" type="text" placeholder="Nhập API key của nhà cung cấp dữ liệu giá (bắt buộc để lấy giá thật)">
              </div>
              <div style="width:120px">
                <label>Nhà cung cấp</label>
                <select id="priceProvider">
                  <option value="metalsapi">Metals-API</option>
                  <option value="alphavantage">AlphaVantage</option>
                </select>
              </div>
            </div>

            <div class="controls" style="margin-top:10px">
              <div style="display:flex;gap:8px">
                <button id="btnStart">Bật cập nhật giá</button>
                <button id="btnStop" class="btn-ghost">Tắt</button>
                <button id="btnAnalyze" class="btn-ghost">Tính lại phân tích</button>
              </div>
              <div class="footer-note">Gợi ý: để giá **thật sự chính xác theo thời gian thực**, nên dùng nhà cung cấp trả phí/đáng tin cậy. Mã này sẽ thử lấy giá mới mỗi 5s (có thể chỉnh).</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- right column: detailed analysis + AI integration -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Phân tích kĩ thuật (tóm lược)</h3>
      <div id="analysisText" class="analysis-text">
        <p style="margin:0">Chưa có dữ liệu — bấm <strong>Bật cập nhật giá</strong> và điền API key để lấy dữ liệu, sau đó bấm <strong>Tính lại phân tích</strong>.</p>
      </div>

      <div style="margin-top:14px" class="card">
        <h4 style="margin:0 0 8px 0">Gửi dữ liệu chart cho AI (Claude / OpenAI)</h4>
        <div style="font-size:13px;color:var(--muted);margin-bottom:8px">
          Bạn có thể gửi JSON báo cáo (giá + phân tích sơ bộ) để AI phân tích thêm và trả về đề xuất chi tiết. <strong>Không nên</strong> để API key OpenAI/Claude lộ ở phía client (bên dưới có tùy chọn an toàn).
        </div>

        <label>Chọn cách gọi AI</label>
        <select id="aiMode">
          <option value="backend">Gọi qua backend an toàn (recommended)</option>
          <option value="direct">Gọi trực tiếp từ client (**không an toàn**, chỉ thử nghiệm)</option>
        </select>

        <div style="margin-top:8px">
          <label>API Key AI (nếu dùng direct)</label>
          <input id="aiApiKey" type="text" placeholder="Nhập OpenAI / Claude API key (chỉ thử nghiệm)">
        </div>

        <div style="margin-top:8px">
          <label>Endpoint backend (nếu chọn backend)</label>
          <input id="backendEndpoint" type="text" placeholder="Ví dụ: https://your-server.com/ai/analyze">
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnSendAi">Gửi báo cáo -> AI</button>
          <button id="btnShowJson" class="btn-ghost">Xem JSON gửi</button>
        </div>

        <div id="aiResponse" style="margin-top:10px;font-size:13px;color:#0b1220"></div>
      </div>

      <div style="margin-top:12px" class="card">
        <h4 style="margin:0 0 8px 0">Cảnh báo & chú ý</h4>
        <ul style="color:var(--muted);margin:0 0 0 16px;padding:0 0 0 8px;">
          <li>Phần phân tích là tự động, chỉ mang tính tham khảo — không phải tư vấn đầu tư.</li>
          <li>Không lưu trữ API key nhạy cảm phía client nếu muốn an toàn.</li>
          <li>Mã này là mẫu: bạn nên triển khai 1 backend để proxy gọi OpenAI/Claude và nhà cung cấp giá.</li>
        </ul>
      </div>
    </div>
  </div>

  <div style="margin-top:18px;text-align:center;color:var(--muted);font-size:12px">
    <div><strong>Ghi chú:</strong> Trang hiển thị "Phân tích XAU/USD theo giá thực" — để hoạt động, hãy cung cấp API key dữ liệu.</div>
  </div>
</div>

<script>
/*
  index.html - Live XAU/USD analysis (mẫu)
  - Tần suất cập nhật mặc định: 5s
  - Hỗ trợ providers: Metals-API, AlphaVantage (mã mẫu)
  - Bạn cần đăng ký API key từ nhà cung cấp dữ liệu giá và nhập vào ô "API Cung cấp Giá".
  - AI integration:
      * mode "backend": gửi POST tới endpoint do bạn cung cấp (recommended)
      * mode "direct": client sẽ gọi OpenAI/Claude trực tiếp (không an toàn, có CORS & lộ key)
*/

// ---------- Cấu hình mặc định ----------
const UPDATE_INTERVAL_MS = 5000; // 5s
let updateTimer = null;
let lastPrice = null;
let recentPrices = []; // lưu vài giá gần nhất cho MA/ATR đơn giản
let currentTF = '1min';

// ---------- DOM ----------
const priceEl = document.getElementById('price');
const priceChangeEl = document.getElementById('priceChange');
const lastUpdatedEl = document.getElementById('lastUpdated');
const scalpEntryEl = document.getElementById('scalp-entry');
const scalpSlEl = document.getElementById('scalp-sl');
const scalpTpEl = document.getElementById('scalp-tp');
const scalpNoteEl = document.getElementById('scalp-note');
const swingEntryEl = document.getElementById('swing-entry');
const swingSlEl = document.getElementById('swing-sl');
const swingTpEl = document.getElementById('swing-tp');
const swingNoteEl = document.getElementById('swing-note');
const analysisTextEl = document.getElementById('analysisText');

// ---------- Timeframe buttons ----------
document.querySelectorAll('.tf').forEach(el=>{
  el.addEventListener('click', ()=> {
    document.querySelectorAll('.tf').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    currentTF = el.dataset.tf;
    manualAnalyze();
  });
});

// ---------- Buttons ----------
document.getElementById('btnStart').addEventListener('click', startUpdates);
document.getElementById('btnStop').addEventListener('click', stopUpdates);
document.getElementById('btnAnalyze').addEventListener('click', manualAnalyze);
document.getElementById('btnShowJson').addEventListener('click', ()=> {
  const j = buildReportJson();
  alert(JSON.stringify(j, null, 2));
});
document.getElementById('btnSendAi').addEventListener('click', sendToAi);

// ---------- Price providers helpers ----------
async function fetchPriceFromProvider(provider, apiKey) {
  // Trả về object: {price: float, timestamp: ISO, raw: {...}}
  // NOTE: endpoints có thể khác — đây là mẫu. Nếu provider chọn là 'metalsapi' thì gọi Metals-API.
  try {
    if (!apiKey) throw new Error('Missing API key for price provider');

    if (provider === 'metalsapi') {
      // Metals-API example:
      // GET https://metals-api.com/api/latest?access_key=APIKEY&base=USD&symbols=XAU
      const url = `https://metals-api.com/api/latest?access_key=${encodeURIComponent(apiKey)}&base=USD&symbols=XAU`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('Lỗi phản hồi từ Metals-API: ' + r.status);
      const j = await r.json();
      // metals-api returns rates: XAU: 0.000... (base USD)
      // We want XAU per 1 USD? To get XAU/USD (price of 1 oz gold in USD) the provider might return different shapes.
      // Many providers return rates where 1 XAU = N USD in a different field. Here we attempt common shapes:
      let price = null;
      if (j && j.rates && typeof j.rates.XAU !== 'undefined') {
        // metals-api often returns (base: USD) rates.XAU = 0.0005 meaning 1 USD = 0.0005 XAU -> so 1 XAU = 1 / rates.XAU USD
        const rate = Number(j.rates.XAU);
        if (rate > 0) price = 1 / rate;
      }
      // fallback: try j.data or j.price
      if (!price && j && j.price) price = Number(j.price);
      if (!price) throw new Error('Không đọc được giá từ Metals-API (shape khác). Kiểm tra tài liệu nhà cung cấp.');
      return {price, timestamp: new Date().toISOString(), raw:j};

    } else if (provider === 'alphavantage') {
      // AlphaVantage: sử dụng "FX_DAILY" or "CURRENCY_EXCHANGE_RATE" — AlphaVantage không có 1 endpoint chuẩn cho XAU,
      // nhưng họ có physical currency data under "DIGITAL_CURRENCY" or GLOBAL_QUOTE. Đây chỉ là ví dụ mẫu.
      // Bạn có thể thay bằng endpoint hợp lệ của nhà cung cấp bạn dùng.
      const url = `https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=XAU&to_currency=USD&apikey=${encodeURIComponent(apiKey)}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('Lỗi AlphaVantage: ' + r.status);
      const j = await r.json();
      // expected j["Realtime Currency Exchange Rate"]["5. Exchange Rate"]
      const key = Object.keys(j)[0];
      const rateObj = j[key];
      if (rateObj && (rateObj['5. Exchange Rate'] || rateObj['Exchange Rate'])) {
        const price = Number(rateObj['5. Exchange Rate'] || rateObj['Exchange Rate']);
        return {price, timestamp: new Date().toISOString(), raw:j};
      }
      throw new Error('AlphaVantage response không chứa Exchange Rate cho XAU/USD trong mẫu này.');
    } else {
      throw new Error('Provider không hỗ trợ: ' + provider);
    }
  } catch (err) {
    throw err;
  }
}

// ---------- Update loop ----------
async function updateOnce() {
  const apiKey = document.getElementById('priceApiKey').value.trim();
  const provider = document.getElementById('priceProvider').value;
  if (!apiKey) {
    analysisTextEl.innerHTML = '<p class="small" style="color:#ef4444">Vui lòng nhập API key của nhà cung cấp giá để lấy giá thực.</p>';
    return;
  }
  try {
    const res = await fetchPriceFromProvider(provider, apiKey);
    const p = Number(res.price);
    if (!isFinite(p)) throw new Error('Giá không hợp lệ: ' + p);

    const now = new Date().toLocaleString();
    lastUpdatedEl.textContent = now;
    priceEl.textContent = p.toFixed(2) + ' USD';
    // change
    if (lastPrice !== null) {
      const diff = p - lastPrice;
      const pct = (diff / lastPrice) * 100;
      priceChangeEl.textContent = (diff>=0?'+':'') + diff.toFixed(2) + ' (' + pct.toFixed(2) + '%)';
      priceChangeEl.style.color = diff >= 0 ? 'var(--success)' : 'var(--danger)';
    } else {
      priceChangeEl.textContent = '--';
      priceChangeEl.style.color = 'var(--muted)';
    }

    // push to recentPrices
    recentPrices.push({t:res.timestamp, p});
    if (recentPrices.length > 500) recentPrices.shift();
    lastPrice = p;

    // auto analyze a bit
    computeEntriesAndRender();

  } catch (err) {
    analysisTextEl.innerHTML = `<p class="small" style="color:var(--danger)">Lỗi lấy giá: ${err.message}</p>`;
    console.error(err);
  }
}

function startUpdates(){
  if (updateTimer) return;
  updateOnce();
  updateTimer = setInterval(updateOnce, UPDATE_INTERVAL_MS);
  document.getElementById('btnStart').disabled = true;
}
function stopUpdates(){
  if (updateTimer) {
    clearInterval(updateTimer);
    updateTimer = null;
    document.getElementById('btnStart').disabled = false;
  }
}

// ---------- Simple analysis helpers ----------
function simpleMA(data, period=14){
  if (!data || data.length < period) return null;
  let sum=0;
  for (let i=data.length-period;i<data.length;i++) sum += data[i].p;
  return sum/period;
}
function simpleATR(closes, period=14){
  // we don't have high/low in this simple model. Use absolute diff of successive closes as proxy.
  if (!closes || closes.length < period+1) return null;
  let sum=0;
  for (let i=closes.length-period;i<closes.length;i++){
    sum += Math.abs(closes[i].p - closes[i-1].p);
  }
  return sum/period;
}

function computeEntriesAndRender(){
  if (!lastPrice) return;

  // Use recentPrices and currentTF as simple proxies.
  // For better data, integrate historical candles per timeframe from provider. This is a sample heuristic.

  const closes = recentPrices.slice(-50); // last ~50 samples
  const maShort = simpleMA(closes, 5) || lastPrice;
  const maLong = simpleMA(closes, 20) || lastPrice;
  const atr = simpleATR(closes, 14) || (lastPrice*0.002); // fallback ATR ~0.2%

  // Determine trend
  const trend = maShort > maLong ? 'UP' : (maShort < maLong ? 'DOWN' : 'FLAT');

  // Scalping: tight SL/TP using ATR
  const scalpEntry = lastPrice;
  const scalpSl = scalpEntry - atr * 0.6 * (trend==='UP'?1:-1);
  const scalpTp = scalpEntry + atr * 1.2 * (trend==='UP'?1:-1);
  // For sell scenario, flip
  const scalpEntryStr = scalpEntry.toFixed(2);
  const scalpSlStr = scalpSl.toFixed(2);
  const scalpTpStr = scalpTp.toFixed(2);
  scalpEntryEl.textContent = scalpEntryStr;
  scalpSlEl.textContent = scalpSlStr;
  scalpTpEl.textContent = scalpTpStr;
  scalpNoteEl.textContent = `Trend: ${trend}. ATR ~ ${atr.toFixed(3)}. Scalping dùng TP ≈ 1.2×ATR, SL ≈ 0.6×ATR.`;

  // Swing: wider, use multiples of ATR and confirm trend
  const swingEntry = lastPrice;
  const swingSl = trend==='UP' ? swingEntry - atr*2.5 : swingEntry + atr*2.5;
  const swingTp = trend==='UP' ? swingEntry + atr*6 : swingEntry - atr*6;
  swingEntryEl.textContent = swingEntry.toFixed(2);
  swingSlEl.textContent = swingSl.toFixed(2);
  swingTpEl.textContent = swingTp.toFixed(2);
  swingNoteEl.textContent = `Trend: ${trend}. Swing uses wider SL/TP (SL≈2.5×ATR, TP≈6×ATR).`;

  // Analysis text
  analysisTextEl.innerHTML = `
    <p><strong>Tóm tắt phân tích (${currentTF}):</strong></p>
    <ul style="color:var(--muted);margin:0;padding-left:18px">
      <li>Giá hiện tại: <strong>${lastPrice.toFixed(2)} USD</strong></li>
      <li>MA5: ${maShort ? maShort.toFixed(2) : '--'}, MA20: ${maLong ? maLong.toFixed(2) : '--'}</li>
      <li>ATR (ước lượng): ${atr ? atr.toFixed(3) : '--'}</li>
      <li>Xu hướng nhanh: <strong>${trend}</strong></li>
    </ul>
    <p style="margin-top:8px;color:var(--muted)">Gợi ý entry/SL/TP ở bên trái (dưới mục Scalping & Swing). Đây là phân tích tự động, nên kiểm tra lại volume / tin tức trước khi vào lệnh.</p>
  `;
}

// Manual analyze (recompute)
function manualAnalyze(){ computeEntriesAndRender(); }

// Build JSON report to send to AI:
function buildReportJson(){
  return {
    symbol: 'XAU/USD',
    timestamp: new Date().toISOString(),
    price: lastPrice,
    recentPrices: recentPrices.slice(-200),
    timeframe: currentTF,
    analysis: {
      scalp: {
        entry: scalpEntryEl.textContent,
        sl: scalpSlEl.textContent,
        tp: scalpTpEl.textContent,
        note: scalpNoteEl.textContent
      },
      swing: {
        entry: swingEntryEl.textContent,
        sl: swingSlEl.textContent,
        tp: swingTpEl.textContent,
        note: swingNoteEl.textContent
      },
      summaryText: analysisTextEl.innerText || ''
    }
  };
}

// Send JSON to AI (either backend or direct)
async function sendToAi(){
  const mode = document.getElementById('aiMode').value;
  const backend = document.getElementById('backendEndpoint').value.trim();
  const aiKey = document.getElementById('aiApiKey').value.trim();

  const payload = buildReportJson();
  document.getElementById('aiResponse').innerText = 'Đang gửi...';

  try {
    if (mode === 'backend') {
      if (!backend) throw new Error('Vui lòng điền endpoint backend của bạn (ví dụ: https://your-server.com/ai/analyze). Backend nên proxy gọi OpenAI/Claude.');
      const r = await fetch(backend, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error('Backend trả lỗi: ' + r.status);
      const j = await r.json();
      document.getElementById('aiResponse').innerText = 'Kết quả AI (từ backend):\n' + JSON.stringify(j, null, 2);
    } else {
      // direct call — caution: CORS & security
      if (!aiKey) throw new Error('Nhập API key AI để gọi trực tiếp (không an toàn).');
      // Example: call OpenAI chat completions (v1/chat/completions) - NOTE: CORS may block this in browser.
      const body = {
        model: "gpt-4o-mini", // placeholder
        messages: [
          {role:'system', content:'Bạn là trợ lý phân tích tài chính chuyên sâu. Đánh giá biểu đồ XAU/USD và đưa ra entry/SL/TP kèm lý do.'},
          {role:'user', content:'Hãy phân tích JSON sau và trả về đề xuất rõ ràng: ' + JSON.stringify(payload)}
        ],
        max_tokens: 600
      };
      const r = await fetch('https://api.openai.com/v1/chat/completions', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization': 'Bearer ' + aiKey
        },
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error('OpenAI trả lỗi: ' + r.status);
      const j = await r.json();
      document.getElementById('aiResponse').innerText = 'Kết quả AI (direct):\n' + JSON.stringify(j, null, 2);
    }
  } catch (err) {
    document.getElementById('aiResponse').innerText = 'Lỗi khi gửi tới AI: ' + err.message;
    console.error(err);
  }
}

// Initialize small demo note
analysisTextEl.innerHTML = `<p class="small" style="color:var(--muted)">Chưa có dữ liệu. Hãy nhập API key dữ liệu giá ở bên trái và nhấn "Bật cập nhật giá".</p>`;

// Optional: try start automatically if API key present (disabled by default)
// if (document.getElementById('priceApiKey').value.trim()) startUpdates();
</script>
</body>
</html>
