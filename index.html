<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aura Entry Helper — RSI14 + LWMA45 + EMA9 (on RSI) + AI MINI</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <style>
    :root{ --bg:#0b1020;--card:#12162a;--muted:#9aa3b2;--text:#eef1f6;--accent:#7c5cff;--ok:#22c55e;--bad:#ef4444 }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:radial-gradient(120% 120% at 10% 0%,#1a1f37 0%,var(--bg) 55%);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand h1{font-size:18px;margin:0}
    .card{background:var(--card);border:1px solid #252a41;border-radius:16px;padding:14px}
    .grid{display:grid;grid-template-columns:1.5fr 1fr;gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted)}
    .row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .row2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    select,input,button,textarea{width:100%;border-radius:12px;border:1px solid #2a3152;background:#0e1430;color:var(--text);padding:10px}
    button{cursor:pointer;font-weight:600}
    .btn{background:linear-gradient(180deg,#3b2fff, #6a58ff);border:none}
    .btn.secondary{background:#182042}
    .btn.ok{background:#204d2d}
    .btn.danger{background:#5a1f25}
    .hint{font-size:12px;color:var(--muted)}
    .tv-embed{height:560px;border-radius:12px;overflow:hidden}
    .mini{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;background:#141a36;border:1px solid #283058;font-size:12px}
    .signal{font-size:14px;line-height:1.55}
    .signal strong{color:#cbd5ff}
    .log{height:180px}
    .footer{margin-top:8px;display:flex;align-items:center;justify-content:space-between}
    .error{color:#ef9a9a;font-size:12px}
    .green{color:var(--ok)}
    .red{color:var(--bad)}
    kbd{background:#101633;border:1px solid #2b3256;border-radius:6px;padding:2px 6px;font-size:12px}
    details{margin-top:10px;color:var(--muted)}
    summary{cursor:pointer}
    /* Drawer (AI MINI) */
    .drawer{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:.2s ease;}
    .drawer.show{opacity:1;pointer-events:auto}
    .drawer .panel{position:absolute;right:0;top:0;bottom:0;width:min(760px,96vw);background:var(--card);border-left:1px solid #2a3152;box-shadow:-10px 0 30px rgba(0,0,0,.35);display:flex;flex-direction:column}
    .drawer .header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #2a3152}
    .drawer .body{padding:12px 14px;overflow:auto}
    .tabs{display:flex;gap:8px;padding:10px 14px;border-bottom:1px solid #2a3152}
    .tabs button{background:#182042;border:1px solid #2a3152;border-radius:10px;padding:8px 12px}
    .tabs button.active{background:linear-gradient(180deg,#3b2fff,#6a58ff);border-color:#3b2fff}
    .drawer .actions{display:flex;gap:8px;padding:10px 14px;border-top:1px solid #2a3152}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l3.09 6.26L22 9.27l-5 4.88L18.18 22 12 18.77 5.82 22 7 14.15l-5-4.88 6.91-1.01L12 2z" fill="#7c5cff"/></svg>
        <h1>Aura Entry Helper</h1>
      </div>
      <div class="mini">
        <span class="pill">1 widget TradingView</span>
        <span class="pill">RSI14 + LWMA45(RSI) + EMA9(RSI)</span>
        <span class="pill">Crypto + FX/Gold</span>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="row">
          <div>
            <label>Nguồn dữ liệu</label>
            <select id="market">
              <option value="binance" selected>Crypto (Binance)</option>
              <option value="stooq">FX / Gold (Stooq)</option>
            </select>
          </div>
          <div>
            <label>Symbol</label>
            <select id="symbol"></select>
          </div>
          <div>
            <label>Khung thời gian</label>
            <select id="interval">
              <option value="5m">5m</option>
              <option value="15m">15m</option>
              <option value="1h" selected>1h</option>
              <option value="4h">4h</option>
              <option value="1d">1d</option>
            </select>
          </div>
          <div>
            <label>ATR period</label>
            <input id="atrPeriod" type="number" min="2" value="14" />
          </div>
          <div>
            <label>ATR SL multiplier</label>
            <input id="atrSL" type="number" step="0.1" value="1.5" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>TP : SL (R:R)</label>
            <input id="rr" type="number" step="0.1" value="2.0" />
          </div>
          <div>
            <label>RSI period (fixed)</label>
            <input type="number" value="14" disabled />
          </div>
          <div>
            <label>LWMA period (fixed)</label>
            <input type="number" value="45" disabled />
          </div>
          <div>
            <label>EMA period (fixed)</label>
            <input type="number" value="9" disabled />
          </div>
          <div>
            <label>Resample 4h (FX)</label>
            <select id="resample4h">
              <option value="on" selected>Bật (từ 60m → 4h)</option>
              <option value="off">Tắt (dùng 60m)</option>
            </select>
          </div>
        </div>

        <!-- Entry controls -->
        <div class="row" style="margin-top:10px">
          <div>
            <label>Entry offset (× ATR)</label>
            <input id="entryATR" type="number" step="0.1" value="0.5" />
          </div>
          <div>
            <label>Entry logic</label>
            <select id="entryLogic">
              <option value="atr" selected>ATR pullback</option>
              <option value="swing">Swing gần nhất</option>
            </select>
          </div>
          <div>
            <label>Min RR để hợp lệ</label>
            <input id="minRR" type="number" step="0.1" value="1.5" />
          </div>
          <div>
            <label>Wick % để nhận dạng Pin bar</label>
            <input id="pinPct" type="number" step="1" value="60" />
          </div>
          <div>
            <label>Phát hiện Divergence</label>
            <select id="divEnable">
              <option value="on" selected>Bật</option>
              <option value="off">Tắt</option>
            </select>
          </div>
        </div>

        <!-- Method presets -->
        <div class="row" style="margin-top:10px">
          <div>
            <label>Phương pháp trade (preset)</label>
            <select id="methodPreset">
              <option value="trend" selected>Trend-Follow (chuẩn)</option>
              <option value="pullback">Pullback (Limit)</option>
              <option value="breakout">Breakout (Stop)</option>
              <option value="momentum">Momentum tiếp diễn (Stop)</option>
              <option value="meanrev">Mean Reversion (Limit)</option>
              <option value="rangefade">Range Fade (Limit)</option>
              <option value="scalping">Scalping ATR (nhanh)</option>
              <option value="swing">Swing trading (pivot)</option>
            </select>
          </div>
          <div>
            <label>Buffer Breakout (× ATR)</label>
            <input id="boBuf" type="number" step="0.1" value="0.2" />
          </div>
          <div>
            <label>Range lookback (bars)</label>
            <input id="rngLook" type="number" min="5" value="20" />
          </div>
        </div>

        <div id="tvWidget" class="tv-embed"></div>
        <div id="err" class="error"></div>
        <div class="footer">
          <div class="hint" id="dsHint">Dữ liệu phân tích lấy từ Binance.</div>
          <div class="mini">
            <button id="refresh" class="btn secondary">↻ Tải dữ liệu</button>
            <button id="auto" class="btn">Phân tích & Gợi ý</button>
          </div>
        </div>
      </section>

      <aside class="card">
        <h3 style="margin:6px 0 8px 0">Gợi ý mở lệnh</h3>
        <div class="row2">
          <button class="btn ok" id="btnLong">Gợi ý BUY (Long)</button>
          <button class="btn danger" id="btnShort">Gợi ý SELL (Short)</button>
        </div>
        <p class="hint" style="margin-top:8px">Logic: EMA9(RSI) cross/trend với LWMA45(RSI) + SL theo ATR, TP theo R:R. Thêm gợi ý Limit/Stop dựa trên vị trí giá.</p>
        <div id="signal" class="signal" style="margin-top:10px"></div>
        <div class="row2" style="margin-top:10px">
          <button id="copy" class="btn secondary">Copy tín hiệu</button>
          <button id="clear" class="btn secondary">Xóa</button>
        </div>

        <hr style="border-color:#2b3256;margin:14px 0">
        <label for="openaiKey">(Tuỳ chọn) OpenAI API Key</label>
        <input id="openaiKey" type="password" placeholder="sk-... (điền nếu muốn AI giải thích)"/>
        <button id="askAI" class="btn" style="margin-top:8px">Nhờ AI giải thích setup</button>
        <div class="row2" style="margin-top:8px">
          <button id="openDeep" class="btn secondary">AI MINI (chuyên sâu)</button>
          <span class="hint" style="align-self:center">Phím tắt: <kbd>D</kbd></span>
        </div>
        <textarea id="aiOut" class="log" placeholder="Giải thích sẽ hiển thị ở đây" readonly></textarea>

<details style="display:none">
          <summary>Chi tiết phát hiện mô hình (AI-like)</summary>
          <pre id="aiLike" style="white-space:pre-wrap; font-size:12px"></pre>
        </details>

<details style="display:none">
          <summary>Phương pháp trade phổ biến (tóm tắt)</summary>
          <ul style="margin:8px 0 0 16px;line-height:1.5">
            <li><strong>Trend-Follow:</strong> đi theo EMA9(RSI) &gt; LWMA45(RSI), vào theo pullback/continuation.</li>
            <li><strong>Pullback (Limit):</strong> chờ giá hồi về vùng ATR/swing rồi đặt LIMIT thuận xu hướng.</li>
            <li><strong>Breakout (Stop):</strong> đặt STOP vượt swing high/low, cần buffer tránh stop-hunt.</li>
            <li><strong>Momentum:</strong> khi RSI/động lượng mạnh, ưu tiên STOP theo hướng hiện tại.</li>
            <li><strong>Mean Reversion:</strong> fade các cú kéo quá đà về trung tâm range/MA, dùng LIMIT và SL chặt.</li>
            <li><strong>Range Fade:</strong> LIMIT ở biên range, TP về giữa range.</li>
            <li><strong>Scalping ATR:</strong> khung nhỏ, entry micro-pullback, TP ngắn, tần suất cao.</li>
            <li><strong>Swing:</strong> retest pivot H/L, TP ở pivot đối diện.</li>
          </ul>
        </details>
      </aside>
    </div>

    <p class="hint" style="margin-top:10px">Mẹo: bấm <kbd>A</kbd> để phân tích nhanh, <kbd>L</kbd> để BUY, <kbd>S</kbd> để SELL, <kbd>D</kbd> để mở AI MINI.</p>

  </div>

  <!-- AI MINI Drawer -->
  <div id="aiDrawer" class="drawer" aria-hidden="true">
    <div id="closeDeep" style="position:absolute;inset:0"></div>
    <div class="panel">
      <div class="header">
        <strong>AI MINI — Phân tích chuyên sâu</strong>
        <button id="closeDeepBtn" class="btn secondary" style="padding:6px 10px">Đóng</button>
      </div>
      <div class="tabs">
        <button id="tabLocal" class="active">Local (AI-like)</button>
        <button id="tabCloud">Cloud (OpenAI)</button>
      </div>
      <div class="body mono" style="white-space:pre-wrap">
        <div id="localPane"></div>
        <div id="cloudPane" style="display:none"></div>
      </div>
      <div class="actions">
        <button id="runLocal" class="btn">Phân tích cục bộ</button>
        <button id="runCloud" class="btn secondary">Phân tích bằng OpenAI</button>
      </div>
    </div>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt = (x, d=2)=> Number(x).toFixed(d);

    const toBinanceInt = (v)=>({"5m":"5m","15m":"15m","1h":"1h","4h":"4h","1d":"1d"}[v]||"15m");
    const toTVInt = (v)=>({"5m":"5","15m":"15","1h":"60","4h":"240","1d":"D"}[v]||"15");
    const toStooqInt = (v)=>({"5m":"5","15m":"15","1h":"60","4h":"60","1d":"d"}[v]||"15");

    function tvSymbolFor(market,sym){
      if(market==='binance') return 'BINANCE:'+sym;
      const map = {
        'XAUUSD':'FX_IDC:XAUUSD','XAGUSD':'FX_IDC:XAGUSD',
        'EURUSD':'FX:EURUSD','GBPUSD':'FX:GBPUSD','USDJPY':'FX:USDJPY','AUDUSD':'FX:AUDUSD','USDCAD':'FX:USDCAD','NZDUSD':'FX:NZDUSD','USDCHF':'FX:USDCHF'
      };
      return map[sym]||'FX:'+sym;
    }
    function createTV(sym, intv){
      const market = $("market").value;
      const el = $("tvWidget");
      el.innerHTML = "";
      if (!window.TradingView || !window.TradingView.widget) {
        el.innerHTML = "<div style='padding:12px;border:1px solid #2b3256;border-radius:12px;background:#0e1430'><div class='error'>Không thể tải TradingView widget.<br>• Kiểm tra mạng/Firewall không chặn s3.tradingview.com<br>• Dùng http://localhost thay vì mở file trực tiếp<br>• Tắt tạm adblock cho trang này</div></div>";
        return;
      }
      new TradingView.widget({
        autosize: true,
        symbol: tvSymbolFor(market, sym),
        interval: toTVInt(intv),
        timezone: "Asia/Ho_Chi_Minh",
        theme: "dark",
        style: "1",
        container_id: "tvWidget",
        withdateranges: true,
        hide_side_toolbar: false,
        allow_symbol_change: true,
        studies: ["RSI@tv-basicstudies","ATR@tv-basicstudies"],
      });
    }

    async function fetchJSON(u){ const r=await fetch(u); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
    async function fetchTEXT(u){ const r=await fetch(u); if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); }

    function resampleCandles(src, stepSec){
      if(!src?.length) return [];
      const out=[];
      let bucketTs = Math.floor(src[0].time/stepSec)*stepSec;
      let o=src[0].open, h=src[0].high, l=src[0].low, c=src[0].close;
      for(let i=1;i<src.length;i++){
        const t=src[i].time;
        if(t < bucketTs+stepSec){
          h=Math.max(h, src[i].high);
          l=Math.min(l, src[i].low);
          c=src[i].close;
        }else{
          out.push({time:bucketTs, open:o, high:h, low:l, close:c});
          bucketTs = Math.floor(t/stepSec)*stepSec;
          o=src[i].open; h=src[i].high; l=src[i].low; c=src[i].close;
        }
      }
      out.push({time:bucketTs, open:o, high:h, low:l, close:c});
      return out;
    }

    async function fetchKlines(symbol, interval, limit=500){
      const market = $("market").value;
      if(market==='binance'){
        const base = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
        const attempts = [ base, `https://cors.isomorphic-git.org/${base}`, `https://api.allorigins.win/raw?url=${encodeURIComponent(base)}` ];
        for(const u of attempts){
          try{ const raw = await fetchJSON(u); return raw.map(k=>({time:Math.floor(k[0]/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4]})); }
          catch(e){}
        }
        throw new Error('Không lấy được dữ liệu nến (Binance)');
      } else {
        const stooqSym = symbol.toLowerCase();
        const i = toStooqInt(interval);
        const base = `https://stooq.com/q/d/l/?s=${stooqSym}&i=${i}`;
        const attempts = [
          base,
          `https://cors.isomorphic-git.org/${base}`,
          `https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`,
          `https://r.jina.ai/http://stooq.com/q/d/l/?s=${stooqSym}&i=${i}`,
          `https://r.jina.ai/https://stooq.com/q/d/l/?s=${stooqSym}&i=${i}`,
        ];
        const parseCSV = (txt) => {
          const lines = txt.trim().split(/\n+/);
          if(lines.length < 2) return [];
          const head = lines[0].toLowerCase();
          const rows = lines.slice(1);
          return rows.map(line=>{
            const parts = line.split(',');
            let d,t,o,h,l,c;
            if(head.includes('time')){ [d,t,o,h,l,c] = parts; }
            else { [d,o,h,l,c] = parts; t = '00:00:00'; }
            const ts = Date.parse(`${d}T${t}Z`);
            return { time: Math.floor(ts/1000), open:+o, high:+h, low:+l, close:+c };
          }).filter(v=>isFinite(v.time) && isFinite(v.open));
        };
        for(const u of attempts){
          try{
            const txt = await fetchTEXT(u);
            let data = parseCSV(txt).slice(-limit);
            if(interval==='4h' && $("resample4h").value==='on' && i==='60'){
              data = resampleCandles(data, 4*60*60);
            }
            if(data.length) return data;
          }catch(e){}
        }
        try{
          const dailyBase = `https://stooq.com/q/d/l/?s=${stooqSym}&i=d`;
          const alt = [ dailyBase, `https://cors.isomorphic-git.org/${dailyBase}`, `https://api.allorigins.win/raw?url=${encodeURIComponent(dailyBase)}`, `https://r.jina.ai/https://stooq.com/q/d/l/?s=${stooqSym}&i=d` ];
          for(const u of alt){
            try{
              const txt = await fetchTEXT(u);
              const data = parseCSV(txt).slice(-limit);
              if(data.length) return data;
            }catch(e){}
          }
        }catch(e){}
        throw new Error('Không lấy được dữ liệu nến (Stooq) – thử lại sau hoặc chuyển Daily.');
      }
    }

    function ema(values, period){ const k=2/(period+1); let prev=values[0]; const out=[prev]; for(let i=1;i<values.length;i++){ const v=values[i]*k+prev*(1-k); out.push(v); prev=v;} return out; }
    function rsi(closes, period){ const g=[],l=[]; for(let i=1;i<closes.length;i++){const d=closes[i]-closes[i-1]; g.push(Math.max(0,d)); l.push(Math.max(0,-d)); } const eg=ema([g[0],...g],period), el=ema([l[0],...l],period); const rs=eg.map((v,i)=>v/(el[i]||1e-9)); return rs.map(v=>100-100/(1+v)); }
    function atr(c, p){ const t=[]; for(let i=0;i<c.length;i++){ if(i===0){t.push(c[i].high-c[i].low);continue;} const h=c[i].high,l=c[i].low,pc=c[i-1].close; t.push(Math.max(h-l,Math.abs(h-pc),Math.abs(l-pc))); } return ema(t,p); }
    function lwma(values, period){
      const out = new Array(values.length).fill(NaN);
      const denom = period*(period+1)/2;
      for(let i=period-1;i<values.length;i++){
        let sum=0; let w=1;
        for(let j=i-period+1;j<=i;j++) sum += values[j]*w++;
        out[i]= sum/denom;
      }
      for(let k=0;k<period-1;k++){ out[k] = values[k]; }
      return out;
    }

    function lastSwingHigh(c, lookback=10){
      const n=c.length-2;
      let hi=-Infinity, idx=-1;
      for(let i=Math.max(1,n-lookback); i<=n; i++){ if(c[i].high>hi){hi=c[i].high; idx=i;} }
      return {price:hi,index:idx};
    }
    function lastSwingLow(c, lookback=10){
      const n=c.length-2;
      let lo=Infinity, idx=-1;
      for(let i=Math.max(1,n-lookback); i<=n; i++){ if(c[i].low<lo){lo=c[i].low; idx=i;} }
      return {price:lo,index:idx};
    }
    function rangeHL(c, look=20){
      const n=c.length-2;
      const from = Math.max(1, n - look);
      let hi=-Infinity, lo=Infinity;
      for(let i=from;i<=n;i++){ hi=Math.max(hi,c[i].high); lo=Math.min(lo,c[i].low); }
      return {hi,lo,mid:(hi+lo)/2};
    }

    function detectPatterns(candles, closes, baseRSI){
      const n = candles.length-1;
      const patt = [];
      const last = candles[n];
      const prev = candles[n-1];
      const isBull = last.close>last.open; const isBear = last.close<last.open;
      const prevBull = prev.close>prev.open; const prevBear = prev.close<prev.open;
      const bodyLast = Math.abs(last.close-last.open);
      const rangeLast = last.high-last.low;
      const wickTop = last.high - Math.max(last.close,last.open);
      const wickBot = Math.min(last.close,last.open) - last.low;
      const pinPct = +$("pinPct").value || 60;
      if(prevBear && isBull && last.close>prev.open && last.open<prev.close){
        patt.push({name:'Bullish Engulfing', dir:'long', score:2});
      }
      if(prevBull && isBear && last.open>prev.close && last.close<prev.open){
        patt.push({name:'Bearish Engulfing', dir:'short', score:2});
      }
      if(isBull && (rangeLast>0) && (wickBot>=bodyLast) && (wickBot/rangeLast*100>=pinPct)){
        patt.push({name:'Bullish Pin Bar', dir:'long', score:1.5});
      }
      if(isBear && (rangeLast>0) && (wickTop>=bodyLast) && (wickTop/rangeLast*100>=pinPct)){
        patt.push({name:'Bearish Pin Bar', dir:'short', score:1.5});
      }
      if($("divEnable").value==='on' && baseRSI.length>6){
        const aIdx = n-5, bIdx = n-1;
        const priceHigherHigh = closes[bIdx] > closes[aIdx] && candles[bIdx].high >= candles[aIdx].high;
        const rsiLowerHigh = baseRSI[bIdx] < baseRSI[aIdx];
        if(priceHigherHigh && rsiLowerHigh){ patt.push({name:'Bearish RSI Divergence', dir:'short', score:1.5}); }
        const priceLowerLow = closes[bIdx] < closes[aIdx] && candles[bIdx].low <= candles[aIdx].low;
        const rsiHigherLow = baseRSI[bIdx] > baseRSI[aIdx];
        if(priceLowerLow && rsiHigherLow){ patt.push({name:'Bullish RSI Divergence', dir:'long', score:1.5}); }
      }
      const scoreLong = patt.filter(p=>p.dir==='long').reduce((s,p)=>s+p.score,0);
      const scoreShort = patt.filter(p=>p.dir==='short').reduce((s,p)=>s+p.score,0);
      return {patterns:patt, scoreLong, scoreShort};
    }

    const BINANCE_SYMBOLS = ['BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT'];
    const STOOQ_SYMBOLS = ['XAUUSD','XAGUSD','EURUSD','GBPUSD','USDJPY','AUDUSD','USDCAD','NZDUSD','USDCHF'];

    function populateSymbols(){
      const sel = $("symbol");
      sel.innerHTML = '';
      const market = $("market").value;
      const arr = market==='binance' ? BINANCE_SYMBOLS : STOOQ_SYMBOLS;
      for(const s of arr){
        const opt=document.createElement('option'); opt.textContent=s; opt.value=s; sel.appendChild(opt);
      }
      sel.value = arr[0];
      $("dsHint").textContent = market==='binance' ? 'Dữ liệu phân tích lấy từ Binance.' : 'Dữ liệu phân tích lấy từ Stooq (qua proxy).';
    }

    let candles=[], lastSignalText='', lastAnalysis=null;

    async function load(){
      $("err").textContent='';
      if($("symbol").options.length===0) populateSymbols();
      const sym = $("symbol").value.trim();
      const intv = $("interval").value;
      createTV(sym, intv);
      try{
        const fetchIntv = $("market").value==='binance'? toBinanceInt(intv): intv;
        candles = await fetchKlines(sym, fetchIntv, 600);
      }catch(e){ $("err").textContent = 'Lỗi dữ liệu: '+e.message; }
    }

    function buildEntryPlan(direction, price, atrVal){
      const mode = $("entryLogic").value;
      const preset = $("methodPreset").value;
      const k = +$("entryATR").value || 0.5;
      const bo = +$("boBuf").value || 0.2;
      const swings = {H:lastSwingHigh(candles,12).price, L:lastSwingLow(candles,12).price};
      const rng = rangeHL(candles, +$("rngLook").value || 20);
      let entryPrice, orderType;
      if(mode==='atr'){
        entryPrice = direction==='long' ? price - k*atrVal : price + k*atrVal;
      }else{
        if(direction==='long') entryPrice = Math.min(price, swings.L + 0.25*(swings.H - swings.L));
        else entryPrice = Math.max(price, swings.H - 0.25*(swings.H - swings.L));
      }
      if(direction==='long') orderType = entryPrice < price ? 'BUY LIMIT' : (entryPrice > price ? 'BUY STOP' : 'MARKET');
      else orderType = entryPrice > price ? 'SELL LIMIT' : (entryPrice < price ? 'SELL STOP' : 'MARKET');
      if(preset==='breakout'){
        if(direction==='long'){ entryPrice = Math.max(price, swings.H + bo*atrVal); orderType='BUY STOP'; }
        else { entryPrice = Math.min(price, swings.L - bo*atrVal); orderType='SELL STOP'; }
      } else if(preset==='pullback' || preset==='trend'){
        if(direction==='long'){ entryPrice = Math.min(price, price - k*atrVal); orderType='BUY LIMIT'; }
        else { entryPrice = Math.max(price, price + k*atrVal); orderType='SELL LIMIT'; }
      } else if(preset==='momentum'){
        if(direction==='long'){ entryPrice = Math.max(price, price + k*atrVal*0.5); orderType='BUY STOP'; }
        else { entryPrice = Math.min(price, price - k*atrVal*0.5); orderType='SELL STOP'; }
      } else if(preset==='meanrev' || preset==='rangefade'){
        if(direction==='long'){ entryPrice = Math.min(price, rng.lo + 0.15*(rng.hi-rng.lo)); orderType='BUY LIMIT'; }
        else { entryPrice = Math.max(price, rng.hi - 0.15*(rng.hi-rng.lo)); orderType='SELL LIMIT'; }
      } else if(preset==='scalping'){
        if(direction==='long'){ entryPrice = price - Math.max(0.3, k*0.5)*atrVal; orderType='BUY LIMIT'; }
        else { entryPrice = price + Math.max(0.3, k*0.5)*atrVal; orderType='SELL LIMIT'; }
      } else if(preset==='swing'){
        if(direction==='long'){ entryPrice = Math.min(price, swings.L + 0.1*(swings.H-swings.L)); orderType='BUY LIMIT'; }
        else { entryPrice = Math.max(price, swings.H - 0.1*(swings.H-swings.L)); orderType='SELL LIMIT'; }
      }
      return {entryPrice, orderType, preset, swings, rng};
    }

    function analyzeRSI(direction){
      if(candles.length<60){ $("signal").innerHTML='<span class="red">Dữ liệu quá ít để phân tích.</span>'; return; }
      const closes = candles.map(c=>c.close);
      const baseRSI = rsi(closes, 14);
      const emaRSI9  = ema(baseRSI, 9);
      const lwmaRSI45 = lwma(baseRSI, 45);
      const at = atr(candles, Math.max(2, +$("atrPeriod").value|0));
      const n = closes.length-1;
      const price = closes[n];
      const rsiV  = baseRSI[n]||50;
      const vol   = at[n]||0;
      const crossUp = emaRSI9[n-1] <= lwmaRSI45[n-1] && emaRSI9[n] > lwmaRSI45[n];
      const crossDn = emaRSI9[n-1] >= lwmaRSI45[n-1] && emaRSI9[n] < lwmaRSI45[n];
      const trendUp = emaRSI9[n] > lwmaRSI45[n];
      const trendDn = emaRSI9[n] < lwmaRSI45[n];
      const ai = detectPatterns(candles, closes, baseRSI);
      $("aiLike").textContent = JSON.stringify({patterns:ai.patterns, scoreLong:ai.scoreLong, scoreShort:ai.scoreShort}, null, 2);
      let ok=false, sl=0, tp=0, why=[];
      if(direction==='long'){
        ok = (crossUp || trendUp) && rsiV > 45 && ai.scoreLong >= ai.scoreShort - 0.5;
        sl = price - +$("atrSL").value * vol;
        tp = price + (+$("rr").value * (price - sl));
        if(crossUp) why.push('EMA9(RSI) cắt LWMA45(RSI) đi lên');
        if(trendUp) why.push('EMA9(RSI) > LWMA45(RSI)');
        if(ai.scoreLong>0) why.push('Mô hình ủng hộ Long: '+ai.patterns.filter(p=>p.dir==='long').map(p=>p.name).join(', '));
        if(ai.scoreShort>ai.scoreLong) why.push('Cảnh báo: có mô hình nghiêng Short');
        why.push(`RSI14=${fmt(rsiV,1)}`);
      } else {
        ok = (crossDn || trendDn) && rsiV < 55 && ai.scoreShort >= ai.scoreLong - 0.5;
        sl = price + +$("atrSL").value * vol;
        tp = price - (+$("rr").value * (sl - price));
        if(crossDn) why.push('EMA9(RSI) cắt LWMA45(RSI) đi xuống');
        if(trendDn) why.push('EMA9(RSI) < LWMA45(RSI)');
        if(ai.scoreShort>0) why.push('Mô hình ủng hộ Short: '+ai.patterns.filter(p=>p.dir==='short').map(p=>p.name).join(', '));
        if(ai.scoreLong>ai.scoreShort) why.push('Cảnh báo: có mô hình nghiêng Long');
        why.push(`RSI14=${fmt(rsiV,1)}`);
      }
      const plan = buildEntryPlan(direction, price, vol);
      const entryPrice = plan.entryPrice; const orderType = plan.orderType;
      const minRR = +$("minRR").value || 1.5;
      const rrNow = direction==='long' ? (tp-entryPrice)/(entryPrice-sl) : (entryPrice-sl)/(tp-entryPrice);
      if(rrNow < minRR) { ok = false; why.push(`RR hiệu dụng (${fmt(rrNow,2)}) < MinRR (${fmt(minRR,2)})`); }
      const sym=$("symbol").value, intv=$("interval").value;
      const status= ok?'<span class="green">PHÙ HỢP</span>':'<span class="red">CHƯA PHÙ HỢP</span>';
      const text=`
— Gợi ý ${direction==='long'?'BUY':'SELL'} (${sym} · ${intv}) —
Order: ${orderType}
Entry: ${fmt(entryPrice)}  (Giá hiện tại: ${fmt(price)})
SL: ${fmt(sl)}  (ATRx${$("atrSL").value})
TP: ${fmt(tp)}  (R:R ${$("rr").value}; RR hiệu dụng≈${fmt(rrNow,2)})
Điều kiện: ${why.join(' · ')}
Cấu hình: RSI14 + LWMA45(RSI) + EMA9(RSI) + AI-like patterns + Preset=${plan.preset}
Kết luận: ${ok?'NÊN CHỜ PULLBACK/STOP THEO KẾ HOẠCH':'Quan sát thêm, đợi xác nhận hoặc điều chỉnh Entry/SL/TP'}
`;
      lastSignalText=text.trim();
      lastAnalysis = {
        symbol: $("symbol").value,
        interval: $("interval").value,
        market: $("market").value,
        price: +fmt(price),
        direction,
        entry: +fmt(entryPrice),
        orderType,
        sl: +fmt(sl),
        tp: +fmt(tp),
        rrConfigured: +$("rr").value,
        rrEffective: +fmt(rrNow,2),
        atrPeriod: Math.max(2, +$("atrPeriod").value|0),
        atrSLmult: +$("atrSL").value,
        entryATRmult: +$("entryATR").value,
        entryLogic: $("entryLogic").value,
        rsi14: +fmt(rsiV,1),
        ema9_gt_lwma45: emaRSI9[n] > lwmaRSI45[n],
        crossUp, crossDn, trendUp, trendDn,
        aiPatterns: ai.patterns,
        aiScoreLong: ai.scoreLong,
        aiScoreShort: ai.scoreShort,
        swings: plan.swings,
        range: plan.rng,
        lastBarTime: candles[n]?.time || null,
        notes: lastSignalText
      };
      $("signal").innerHTML=`<strong>Kết quả:</strong> ${status}<br><br><pre style="white-space:pre-wrap">${text}</pre>`;
    }

    $("refresh").onclick=load;
    $("auto").onclick = async () => {
      try{
        $("err").textContent='';
        if(!candles.length) await load();
        if(!candles.length){ $("err").textContent='Không có dữ liệu để phân tích.'; return; }
        const closes = candles.map(c=>c.close);
        if(closes.length<60){
          $("signal").innerHTML='<span class="red">Dữ liệu quá ít (cần ≥ 60 nến). Hãy chọn khung thời gian lớn hơn hoặc thử lại.</span>';
          return;
        }
        const baseRSI = rsi(closes, 14);
        const emaRSI9 = ema(baseRSI, 9);
        const lwmaRSI45 = lwma(baseRSI, 45);
        const n = closes.length-1;
        if(!isFinite(emaRSI9[n]) || !isFinite(lwmaRSI45[n])){
          $("err").textContent='Không đủ dữ liệu để tính RSI/EMA/LWMA.';
          return;
        }
        const dir = (emaRSI9[n] >= lwmaRSI45[n]) ? 'long' : 'short';
        analyzeRSI(dir);
      }catch(e){
        $("err").textContent = 'Lỗi Auto Analyze: '+ e.message;
      }
    };
    $("btnLong").onclick=()=>analyzeRSI('long');
    $("btnShort").onclick=()=>analyzeRSI('short');
    $("clear").onclick=()=>{ $("signal").innerHTML=''; lastSignalText=''; lastAnalysis=null; $("aiLike").textContent=''; };
    $("copy").onclick=()=>{ if(!lastSignalText) return; navigator.clipboard.writeText(lastSignalText); };

    $("askAI").onclick = async () => {
      const key = $("openaiKey").value.trim();
      if (!key) { $("aiOut").value = 'Vui lòng dán OpenAI API key.'; return; }
      if (!lastSignalText || !lastAnalysis) { $("aiOut").value = 'Hãy bấm Phân tích & Gợi ý trước.'; return; }
      $("aiOut").value = 'Đang phân tích với AI...';
      const systemPrompt = [
        "Bạn là trợ lý phân tích kỹ thuật.",
        "Nhiệm vụ: giải thích setup, nêu rủi ro, điều kiện vô hiệu (invalidation),",
        "gợi ý quản lý lệnh (vào/thoát/tỉ lệ vị thế), và cảnh báo khi RR/SL thiếu an toàn.",
        "Trả lời ngắn gọn, gạch đầu dòng, tiếng Việt."
      ].join(" ");
      const userPrompt = [
        "Dưới đây là dữ liệu setup ở dạng JSON. Hãy giải thích và đánh giá rủi ro,",
        "đưa ra điều kiện vô hiệu, và gợi ý quản lý lệnh cụ thể:",
        "```json",
        JSON.stringify(lastAnalysis, null, 2),
        "```",
        "",
        "Lưu ý:",
        "- Nếu tín hiệu yếu (chỉ trend mà không có cross) hãy khuyến nghị chờ pullback hoặc nến xác nhận.",
        "- Nếu ATR quá nhỏ/SL quá ngắn với khung thời gian hiện tại, hãy cảnh báo nguy cơ whipsaw.",
        "- Nếu R:R < 1.5, khuyên điều chỉnh TP/SL hoặc bỏ lệnh."
      ].join("\n");
      try {
        const r = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
          body: JSON.stringify({ model: "gpt-4o-mini", temperature: 0.2, messages: [ { role: "system", content: systemPrompt }, { role: "user", content: userPrompt } ] })
        });
        const j = await r.json();
        const out = j?.choices?.[0]?.message?.content;
        $("aiOut").value = out || JSON.stringify(j, null, 2);
      } catch (e) {
        $("aiOut").value = 'Lỗi gọi OpenAI: ' + e.message;
      }
    };

    // ===== AI MINI: Deep analysis =====
    function openDrawer(){ const d=$("aiDrawer"); if(d){ d.classList.add('show'); d.setAttribute('aria-hidden','false'); } }
    function closeDrawer(){ const d=$("aiDrawer"); if(d){ d.classList.remove('show'); d.setAttribute('aria-hidden','true'); } }
    function switchTab(which){
      const a=$("tabLocal"), b=$("tabCloud"), lp=$("localPane"), cp=$("cloudPane");
      if(which==='local'){ a.classList.add('active'); b.classList.remove('active'); lp.style.display='block'; cp.style.display='none'; }
      else { b.classList.add('active'); a.classList.remove('active'); lp.style.display='none'; cp.style.display='block'; }
    }

    function buildDeepLocalReport(){
      if(!lastAnalysis){ return 'Chưa có dữ liệu. Hãy bấm \"Phân tích & Gợi ý\" trước.'; }
      const a = lastAnalysis;
      const dir = a.direction==='long' ? 'BUY' : 'SELL';
      const sec = [];

      // Vùng giá (zones)
      const hi = a.range?.hi, lo = a.range?.lo, mid = a.range?.mid;
      const sh = a.swings?.H, sl = a.swings?.L;
      sec.push('# Vùng giá chính');
      if(hi!=null && lo!=null){ sec.push(`- Range gần đây: [${fmt(lo)}, ${fmt(hi)}], Mid ≈ ${fmt(mid)}`); }
      if(sh!=null && sl!=null){ sec.push(`- Swing gần nhất: High ≈ ${fmt(sh)} · Low ≈ ${fmt(sl)}`); }
      sec.push('');

      // Tóm tắt
      sec.push('# Tóm tắt tín hiệu');
      sec.push(`- Hướng: **${dir}** · Order: **${a.orderType}**`);
      sec.push(`- Entry: ${fmt(a.entry)} · SL: ${fmt(a.sl)} · TP: ${fmt(a.tp)} · RR cấu hình: ${fmt(a.rrConfigured,2)} · RR hiệu dụng: ${fmt(a.rrEffective,2)}`);
      sec.push('');

      // Lý do chọn hướng
      const reasons = [];
      if(a.crossUp) reasons.push('EMA9(RSI) cắt lên LWMA45(RSI)');
      if(a.crossDn) reasons.push('EMA9(RSI) cắt xuống LWMA45(RSI)');
      if(a.trendUp) reasons.push('EMA9(RSI) > LWMA45(RSI) (trend up)');
      if(a.trendDn) reasons.push('EMA9(RSI) < LWMA45(RSI) (trend down)');
      reasons.push(`RSI14 hiện tại ≈ ${fmt(a.rsi14,1)}`);
      if(a.aiPatterns?.length){
        const longs = a.aiPatterns.filter(p=>p.dir==='long').map(p=>p.name);
        const shorts = a.aiPatterns.filter(p=>p.dir==='short').map(p=>p.name);
        if(longs.length) reasons.push('Mô hình ủng hộ Long: '+longs.join(', '));
        if(shorts.length) reasons.push('Mô hình ủng hộ Short: '+shorts.join(', '));
        reasons.push(`Điểm: Long=${a.aiScoreLong||0} · Short=${a.aiScoreShort||0}`);
      }
      sec.push('# Vì sao chọn '+dir);
      sec.push('- ' + reasons.join('\n- '));
      sec.push('');

      // Lý do dùng Order
      sec.push('# Vì sao dùng '+a.orderType);
      if(a.orderType.includes('LIMIT')){
        sec.push('- Ưu tiên giá hồi (pullback) để tối ưu RR và giảm trượt giá.');
        if(a.direction==='long' && a.entry<a.price) sec.push('- Entry dưới giá hiện tại → BUY LIMIT đúng quy tắc.');
        if(a.direction==='short' && a.entry>a.price) sec.push('- Entry trên giá hiện tại → SELL LIMIT đúng quy tắc.');
      } else if(a.orderType.includes('STOP')){
        sec.push('- Chỉ khớp khi breakout xác nhận lực (tránh bắt dao rơi / đu đỉnh).');
        if(a.direction==='long' && a.entry>a.price) sec.push('- Entry trên giá hiện tại → BUY STOP đúng quy tắc.');
        if(a.direction==='short' && a.entry<a.price) sec.push('- Entry dưới giá hiện tại → SELL STOP đúng quy tắc.');
      } else {
        sec.push('- MARKET khi cần vào ngay (cân nhắc trượt giá & spread).');
      }
      sec.push('');

      // Rủi ro & Invalidation
      sec.push('# Rủi ro & Invalidation');
      sec.push('- Invalidation: đóng nến vượt SL hoặc EMA9(RSI) đảo hướng so với LWMA45(RSI).');
      sec.push(`- Cảnh báo RR: ${a.rrEffective < (Number($("minRR").value)||1.5) ? 'RR hiệu dụng < ngưỡng' : 'RR hiệu dụng đạt yêu cầu'}.`);
      sec.push('');

      // Quản lý lệnh
      sec.push('# Quản lý lệnh gợi ý');
      sec.push(`- Vào lệnh: ${a.orderType} tại ${fmt(a.entry)}; có thể rải vị thế 2–3 phần quanh entry nếu biến động lớn.`);
      sec.push('- Dời SL: theo ATR hoặc theo đáy/đỉnh swing sau khi có nến xác nhận.');
      sec.push('- Chốt lời: chia TP 1R/1.5R/2R, phần còn lại trailing.');
      sec.push('');

      // Kịch bản thay thế
      sec.push('# Kịch bản thay thế');
      sec.push('- A) Nếu khớp lệnh và đi thuận: dời SL về BE sau 1R, theo dõi phân kỳ RSI ngược chiều.');
      sec.push('- B) Nếu không khớp và đảo chiều: huỷ lệnh chờ, đợi setup lại với tín hiệu xác nhận.');

      return sec.join('\n');
    }

    function runLocalDeep(){ const box=$("localPane"); if(box){ box.textContent = buildDeepLocalReport(); } switchTab('local'); }
    async function runCloudDeep(){
      const key = $("openaiKey").value.trim();
      const box = $("cloudPane"); if(!box) return;
      if(!key){ box.textContent = 'Vui lòng dán OpenAI API key ở panel chính.'; switchTab('cloud'); return; }
      if(!lastAnalysis){ box.textContent = 'Chưa có dữ liệu. Hãy bấm \"Phân tích & Gợi ý\" trước.'; switchTab('cloud'); return; }
      box.textContent = 'Đang phân tích sâu bằng OpenAI...';
      try{
        const systemPrompt = 'Bạn là chuyên gia price action & risk. Viết ngắn gọn, theo mục, nêu invalidation, quản trị rủi ro, và kịch bản thay thế.';
        const userPrompt = 'Hãy phân tích chuyên sâu setup JSON sau, chia thành: Vùng giá, Lý do hướng, Lý do Order (Limit/Stop), Mô hình, Rủi ro & Invalidation, Quản lý lệnh, Kịch bản A/B:\\n```json\\n'+JSON.stringify(lastAnalysis,null,2)+'\\n```';
        const r = await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
          body: JSON.stringify({model:'gpt-4o-mini', temperature:0.2, messages:[{role:'system',content:systemPrompt},{role:'user',content:userPrompt}]})
        });
        const j = await r.json();
        const out = j?.choices?.[0]?.message?.content || JSON.stringify(j,null,2);
        box.textContent = out;
        switchTab('cloud');
      }catch(e){ box.textContent = 'Lỗi OpenAI: '+e.message; switchTab('cloud'); }
    }

    $("openDeep").onclick = ()=>{ if(!lastAnalysis) { $("auto").click(); setTimeout(()=>{ openDrawer(); runLocalDeep(); }, 80); } else { openDrawer(); runLocalDeep(); } };
    $("closeDeep").onclick = closeDrawer; $("closeDeepBtn").onclick = closeDrawer;
    $("tabLocal").onclick = ()=>switchTab('local');
    $("tabCloud").onclick = ()=>switchTab('cloud');
    $("runLocal").onclick = runLocalDeep;
    $("runCloud").onclick = runCloudDeep;

    window.addEventListener('load', ()=>{ populateSymbols(); load(); });
    $("market").addEventListener('change', ()=>{ populateSymbols(); load(); });
    $("symbol").addEventListener('change', load);
    $("interval").addEventListener('change', load);
    $("resample4h").addEventListener('change', load);
    window.addEventListener('keydown', (e)=>{
      const k = e.key.toLowerCase();
      if(k==='a') $("auto").click();
      if(k==='l') $("btnLong").click();
      if(k==='s') $("btnShort").click();
      if(k==='d') { openDrawer(); runLocalDeep(); }
    });
  </script>
</body>
</html>
